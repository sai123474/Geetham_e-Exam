<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Analytics - Geetham e-Exam</title>
    <link rel="icon" type="image/jpeg" href="/geetham.jpg" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg:#f8f9fa; --card:#fff; --text:#1f2937; --muted:#6b7280; --brand:#0056b3;
            --brand-2:#007bff; --ok:#28a745; --warn:#f59e0b; --danger:#dc3545; --info:#17a2b8;
            --border:#e5e7eb; --shadow:0 4px 12px rgba(0,0,0,.08);
        }
        body{font-family:Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:16px;line-height:1.5;}
        .container{max-width:1400px;margin:auto;background:var(--card);padding:24px;border-radius:12px;box-shadow:var(--shadow);}
        .header{text-align:center;margin-bottom:16px;}
        .header img{max-height:64px;}
        .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;justify-content:space-between;align-items:center;}
        select,input[type="text"]{padding:8px 12px;font-size:16px;border-radius:8px;border:1px solid var(--border);}
        button{padding:8px 12px;border:none;border-radius:8px;color:white;cursor:pointer;}
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--brand);
            margin: 10px 0;
        }
        .stat-label {
            color: var(--muted);
            font-size: 14px;
        }
        .table-wrap{border:1px solid var(--border);border-radius:8px;overflow:auto;margin-top: 20px;}
        table{width:100%;border-collapse:collapse;}
        thead th{position:sticky;top:0;background:var(--brand);color:#fff;padding:10px;cursor:pointer;text-align:center;}
        tbody td{padding:10px;border-top:1px solid var(--border);text-align:center;}
        #auth-check { padding: 40px; text-align: center; }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
        
        /* Loading indicator */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 123, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--brand-2);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #121212;
                --card: #1e1e1e;
                --text: #e0e0e0;
                --muted: #a0a0a0;
                --border: #333;
            }
            .chart-card, .stat-card {
                background: var(--card);
            }
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
<div id="auth-check" style="display:none;">
    <h2>Authentication Required</h2>
    <p>Please log in via the <a href="/admin.html">Admin Panel</a> to view analytics.</p>
</div>

<div class="container" id="main-content" style="display:none;">
    <div class="header">
        <img src="/geetham.jpg" alt="Geetham Logo">
        <h1>Analytics Dashboard</h1>
    </div>
    <div class="toolbar">
        <div>
            <label for="quizFilter">Quiz:</label>
            <select id="quizFilter"><option value="all">All Quizzes</option></select>
            <label for="dateRange">Date Range:</label>
            <select id="dateRange">
                <option value="all">All Time</option>
                <option value="7">Last 7 Days</option>
                <option value="30">Last 30 Days</option>
                <option value="90">Last 90 Days</option>
            </select>
        </div>
        <div>
            <button id="refreshBtn" style="background:var(--ok);">⟳ Refresh</button>
            <button id="exportBtn" style="background:var(--info);">⬇ Export Data</button>
        </div>
    </div>
    
    <!-- Summary Statistics -->
    <div class="stats-grid" id="stats-grid">
        <div class="loading-container">
            <div class="loading-spinner"></div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="charts-container">
        <div class="chart-card">
            <h3>Score Distribution</h3>
            <canvas id="scoreDistChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>Subject Performance</h3>
            <canvas id="subjectChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>Time Trend</h3>
            <canvas id="trendChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>Question Difficulty Analysis</h3>
            <canvas id="difficultyChart"></canvas>
        </div>
    </div>
    
    <!-- Question Analysis Table -->
    <h2>Question Analysis</h2>
    <div class="table-wrap">
        <table id="question-analysis-table">
            <thead>
                <tr>
                    <th>Question</th>
                    <th>Subject</th>
                    <th>Correct %</th>
                    <th>Incorrect %</th>
                    <th>Skipped %</th>
                    <th>Avg Time (sec)</th>
                    <th>Difficulty</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="7">Loading question analysis...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Student Performance Table -->
    <h2>Student Performance</h2>
    <div class="table-wrap">
        <table id="student-performance-table">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Mobile</th>
                    <th>Quiz</th>
                    <th>Score</th>
                    <th>Percentile</th>
                    <th>Time Taken</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="7">Loading student performance...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    (function(){
        let allResults = [], allQuizzes = [], filteredResults = [];
        const token = localStorage.getItem('adminToken');
        
        if (!token) {
            document.getElementById('auth-check').style.display = 'block';
            return;
        }
        document.getElementById('main-content').style.display = 'block';
        
        // Chart instances
        let scoreDistChart, subjectChart, trendChart, difficultyChart;
        
        // Initialize charts
        function initCharts() {
            // Score Distribution Chart
            const scoreCtx = document.getElementById('scoreDistChart').getContext('2d');
            scoreDistChart = new Chart(scoreCtx, {
                type: 'bar',
                data: {
                    labels: ['0-20%', '21-40%', '41-60%', '61-80%', '81-100%'],
                    datasets: [{
                        label: 'Number of Students',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: '#007bff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Score Distribution'
                        }
                    }
                }
            });
            
            // Subject Performance Chart
            const subjectCtx = document.getElementById('subjectChart').getContext('2d');
            subjectChart = new Chart(subjectCtx, {
                type: 'radar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Average Score %',
                        data: [],
                        backgroundColor: 'rgba(0, 123, 255, 0.2)',
                        borderColor: '#007bff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            
            // Time Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Average Score',
                        data: [],
                        borderColor: '#007bff',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Question Difficulty Chart
            const difficultyCtx = document.getElementById('difficultyChart').getContext('2d');
            difficultyChart = new Chart(difficultyCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Easy', 'Medium', 'Hard'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Update charts with filtered data
        function updateCharts() {
            if (filteredResults.length === 0) {
                return;
            }
            
            // Score Distribution
            const scoreRanges = [0, 0, 0, 0, 0]; // 0-20%, 21-40%, etc.
            filteredResults.forEach(result => {
                const scorePercent = (result.finalTotalScore / result.totalMaxScore) * 100;
                const rangeIndex = Math.min(Math.floor(scorePercent / 20), 4);
                scoreRanges[rangeIndex]++;
            });
            scoreDistChart.data.datasets[0].data = scoreRanges;
            scoreDistChart.update();
            
            // Subject Performance
            const subjects = new Set();
            const subjectScores = {};
            const subjectCounts = {};
            
            filteredResults.forEach(result => {
                if (result.subjectScores) {
                    Object.entries(result.subjectScores).forEach(([subject, score]) => {
                        subjects.add(subject);
                        if (!subjectScores[subject]) {
                            subjectScores[subject] = 0;
                            subjectCounts[subject] = 0;
                        }
                        subjectScores[subject] += score;
                        subjectCounts[subject]++;
                    });
                }
            });
            
            const subjectLabels = Array.from(subjects);
            const subjectData = subjectLabels.map(subject => {
                const avgScore = subjectScores[subject] / subjectCounts[subject];
                // Find the max possible score for this subject
                const quiz = allQuizzes.find(q => q.id === filteredResults[0].quizId);
                let maxScore = 0;
                if (quiz && quiz.subjects && quiz.subjects[subject]) {
                    maxScore = quiz.subjects[subject].reduce((sum, q) => {
                        return sum + ((quiz.marksMode === 'custom' ? q.correctMarks : quiz.correctMarks) || 1);
                    }, 0);
                }
                return maxScore > 0 ? (avgScore / maxScore) * 100 : 0;
            });
            
            subjectChart.data.labels = subjectLabels;
            subjectChart.data.datasets[0].data = subjectData;
            subjectChart.update();
            
            // Time Trend
            const dateMap = new Map();
            filteredResults.forEach(result => {
                const date = new Date(result.date).toLocaleDateString();
                if (!dateMap.has(date)) {
                    dateMap.set(date, { total: 0, count: 0 });
                }
                dateMap.get(date).total += (result.finalTotalScore / result.totalMaxScore) * 100;
                dateMap.get(date).count++;
            });
            
            const sortedDates = Array.from(dateMap.keys()).sort((a, b) => new Date(a) - new Date(b));
            const avgScores = sortedDates.map(date => {
                const { total, count } = dateMap.get(date);
                return total / count;
            });
            
            trendChart.data.labels = sortedDates;
            trendChart.data.datasets[0].data = avgScores;
            trendChart.update();
            
            // Question Difficulty (based on correct answer percentage)
            const questionStats = calculateQuestionStats();
            const easyCount = questionStats.filter(q => q.correctPercent >= 70).length;
            const hardCount = questionStats.filter(q => q.correctPercent < 40).length;
            const mediumCount = questionStats.length - easyCount - hardCount;
            
            difficultyChart.data.datasets[0].data = [easyCount, mediumCount, hardCount];
            difficultyChart.update();
        }
        
        // Calculate statistics for each question
        function calculateQuestionStats() {
            const questionStats = [];
            const quizId = document.getElementById('quizFilter').value;
            if (quizId === 'all') return questionStats;
            
            const quiz = allQuizzes.find(q => q.id.toString() === quizId);
            if (!quiz) return questionStats;
            
            const relevantResults = filteredResults.filter(r => r.quizId.toString() === quizId);
            if (relevantResults.length === 0) return questionStats;
            
            Object.entries(quiz.subjects).forEach(([subject, questions]) => {
                questions.forEach((question, qIndex) => {
                    let attempted = 0;
                    let correct = 0;
                    let skipped = 0;
                    
                    relevantResults.forEach(result => {
                        const response = result.responses?.[subject]?.[qIndex];
                        if (!response) {
                            skipped++;
                            return;
                        }
                        
                        attempted++;
                        if (question.type === 'multiple-choice') {
                            if (response.answer === response.shuffledCorrectAnswerIndex) {
                                correct++;
                            }
                        } else if (question.type === 'fill-in-the-blank') {
                            const correctAnswers = (question.answerKey || '').split('|').map(a => a.trim().toLowerCase());
                            if (response.answer && correctAnswers.includes(response.answer.toString().trim().toLowerCase())) {
                                correct++;
                            }
                        }
                    });
                    
                    const totalResponses = relevantResults.length;
                    questionStats.push({
                        text: question.text,
                        subject,
                        correctPercent: totalResponses > 0 ? (correct / totalResponses) * 100 : 0,
                        incorrectPercent: totalResponses > 0 ? ((attempted - correct) / totalResponses) * 100 : 0,
                        skippedPercent: totalResponses > 0 ? (skipped / totalResponses) * 100 : 0,
                        avgTime: 0, // We don't have time data yet
                        difficulty: correct / attempted >= 0.7 ? 'Easy' : correct / attempted >= 0.4 ? 'Medium' : 'Hard'
                    });
                });
            });
            
            return questionStats;
        }
        
        // Update summary statistics
        function updateStats() {
            const statsGrid = document.getElementById('stats-grid');
            
            if (filteredResults.length === 0) {
                statsGrid.innerHTML = '<div class="stat-card"><p>No data available for the selected filters.</p></div>';
                return;
            }
            
            // Calculate statistics
            const totalStudents = filteredResults.length;
            const totalQuizzes = new Set(filteredResults.map(r => r.quizId)).size;
            
            let totalScore = 0;
            let totalMaxScore = 0;
            filteredResults.forEach(r => {
                totalScore += r.finalTotalScore || 0;
                totalMaxScore += r.totalMaxScore || 100;
            });
            const avgScore = totalScore / totalStudents;
            const avgScorePercent = (totalScore / totalMaxScore) * 100;
            
            // Calculate pass rate (assuming 40% is passing)
            const passCount = filteredResults.filter(r => {
                const scorePercent = ((r.finalTotalScore || 0) / (r.totalMaxScore || 100)) * 100;
                return scorePercent >= 40;
            }).length;
            const passRate = (passCount / totalStudents) * 100;
            
            // Calculate high performers (>80%)
            const highPerformers = filteredResults.filter(r => {
                const scorePercent = ((r.finalTotalScore || 0) / (r.totalMaxScore || 100)) * 100;
                return scorePercent >= 80;
            }).length;
            const highPerformerRate = (highPerformers / totalStudents) * 100;
            
            // Calculate average warnings
            const totalWarnings = filteredResults.reduce((sum, r) => sum + (r.warnings || 0), 0);
            const avgWarnings = totalWarnings / totalStudents;
            
            // Update the stats grid
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Students</div>
                    <div class="stat-value">${totalStudents}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Average Score</div>
                    <div class="stat-value">${avgScorePercent.toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pass Rate</div>
                    <div class="stat-value">${passRate.toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">High Performers</div>
                    <div class="stat-value">${highPerformerRate.toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg. Warnings</div>
                    <div class="stat-value">${avgWarnings.toFixed(1)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Quizzes</div>
                    <div class="stat-value">${totalQuizzes}</div>
                </div>
            `;
        }
        
        // Update question analysis table
        function updateQuestionAnalysis() {
            const table = document.getElementById('question-analysis-table').querySelector('tbody');
            const questionStats = calculateQuestionStats();
            
            if (questionStats.length === 0) {
                table.innerHTML = '<tr><td colspan="7">No question data available for the selected quiz.</td></tr>';
                return;
            }
            
            table.innerHTML = '';
            questionStats.forEach(stat => {
                const row = table.insertRow();
                row.innerHTML = `
                    <td>${stat.text}</td>
                    <td>${stat.subject}</td>
                    <td>${stat.correctPercent.toFixed(1)}%</td>
                    <td>${stat.incorrectPercent.toFixed(1)}%</td>
                    <td>${stat.skippedPercent.toFixed(1)}%</td>
                    <td>N/A</td>
                    <td>${stat.difficulty}</td>
                `;
            });
        }
        
        // Update student performance table
        function updateStudentPerformance() {
            const table = document.getElementById('student-performance-table').querySelector('tbody');
            
            if (filteredResults.length === 0) {
                table.innerHTML = '<tr><td colspan="7">No student data available for the selected filters.</td></tr>';
                return;
            }
            
            // Calculate percentiles
            const scores = filteredResults.map(r => (r.finalTotalScore / r.totalMaxScore) * 100);
            scores.sort((a, b) => a - b);
            
            table.innerHTML = '';
            filteredResults.forEach(result => {
                const scorePercent = (result.finalTotalScore / result.totalMaxScore) * 100;
                const percentile = scores.findIndex(s => s >= scorePercent) / scores.length * 100;
                
                const row = table.insertRow();
                row.innerHTML = `
                    <td>${result.studentName}</td>
                    <td>${result.mobile}</td>
                    <td>${result.quizTitle}</td>
                    <td>${scorePercent.toFixed(1)}%</td>
                    <td>${percentile.toFixed(1)}</td>
                    <td>N/A</td>
                    <td>${new Date(result.date).toLocaleDateString()}</td>
                `;
            });
        }
        
        // Apply filters and update all visualizations
        function applyFilters() {
            const quizId = document.getElementById('quizFilter').value;
            const dateRange = parseInt(document.getElementById('dateRange').value);
            
            filteredResults = allResults.filter(result => {
                // Filter by quiz
                if (quizId !== 'all' && result.quizId.toString() !== quizId) {
                    return false;
                }
                
                // Filter by date range
                if (dateRange !== NaN && dateRange > 0) {
                    const resultDate = new Date(result.date);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - dateRange);
                    if (resultDate < cutoffDate) {
                        return false;
                    }
                }
                
                return true;
            });
            
            updateStats();
            updateCharts();
            updateQuestionAnalysis();
            updateStudentPerformance();
        }
        
        // Fetch data and initialize
        async function fetchData() {
            try {
                const [resultsRes, quizzesRes] = await Promise.all([
                    fetch('/results'),
                    fetch('/get-quizzes')
                ]);
                
                if (!resultsRes.ok || !quizzesRes.ok) {
                    throw new Error('Failed to fetch data');
                }
                
                allResults = await resultsRes.json();
                allQuizzes = await quizzesRes.json();
                
                // Normalize results
                allResults = allResults.map(r => {
                    const quiz = allQuizzes.find(q => q.id === r.quizId);
                    return {
                        ...r,
                        quizTitle: quiz ? quiz.title : (r.quizTitle || "Untitled Quiz"),
                        finalTotalScore: Number(r.totalScore || 0),
                        totalMaxScore: quiz ? calculateMaxScore(quiz) : 100,
                        date: r.date || new Date().toISOString()
                    };
                });
                
                // Populate quiz filter
                const quizFilter = document.getElementById('quizFilter');
                quizFilter.innerHTML = '<option value="all">All Quizzes</option>';
                const uniqueQuizzes = [...new Set(allResults.map(r => r.quizId))];
                uniqueQuizzes.forEach(id => {
                    const quiz = allQuizzes.find(q => q.id === id);
                    if (quiz) {
                        quizFilter.innerHTML += `<option value="${id}">${quiz.title}</option>`;
                    }
                });
                
                // Initialize charts
                initCharts();
                
                // Apply initial filters
                applyFilters();
                
                // Set up event listeners
                document.getElementById('quizFilter').addEventListener('change', applyFilters);
                document.getElementById('dateRange').addEventListener('change', applyFilters);
                document.getElementById('refreshBtn').addEventListener('click', fetchData);
                document.getElementById('exportBtn').addEventListener('click', exportData);
                
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Failed to fetch data. Please ensure you are logged in and the server is running.');
            }
        }
        
        // Calculate max score for a quiz
        function calculateMaxScore(quiz) {
            if (!quiz?.subjects) return 100;
            let totalMax = 0;
            Object.values(quiz.subjects).forEach(subjectQuestions => {
                subjectQuestions.forEach(q => {
                    totalMax += Number((quiz.marksMode === 'custom' ? q.correctMarks : quiz.correctMarks) || 1);
                });
            });
            return totalMax > 0 ? totalMax : 100;
        }
        
        // Export data as CSV
        function exportData() {
            if (filteredResults.length === 0) {
                alert('No data to export.');
                return;
            }
            
            // Create CSV content
            let csv = 'Student Name,Mobile,Quiz,Score,Max Score,Score %,Date\n';
            filteredResults.forEach(r => {
                const scorePercent = (r.finalTotalScore / r.totalMaxScore) * 100;
                csv += `"${r.studentName}","${r.mobile}","${r.quizTitle}",${r.finalTotalScore},${r.totalMaxScore},${scorePercent.toFixed(1)}%,${new Date(r.date).toLocaleDateString()}\n`;
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'geetham_analytics_export.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Start the application
        fetchData();
    })();
</script>
</body>
</html>