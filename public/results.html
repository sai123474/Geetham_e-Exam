<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Results - Geetham e-Exam</title>
    <link rel="icon" type="image/jpeg" href="/geetham.jpg" />
    <style>
        :root {
            --bg: #f8f9fa; --card: #fff; --text: #1f2937; --muted: #6b7280; --brand: #0056b3;
            --brand-2: #007bff; --ok: #28a745; --warn: #f59e0b; --danger: #dc3545; --info: #17a2b8;
            --border: #e5e7eb; --shadow: 0 4px 12px rgba(0,0,0,.08);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 16px; }
        .container { max-width: 1400px; margin: auto; background: var(--card); padding: 24px; border-radius: 12px; box-shadow: var(--shadow); }
        .header { display: flex; align-items: center; gap: 16px; justify-content: center; text-align: center; margin-bottom: 16px; }
        .logo { max-height: 64px; }
        h1, h3 { color: var(--brand); }
        h1 { font-size: clamp(1.2rem, 2.5vw, 1.75rem); margin: 0; }
        .toolbar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; margin: 12px 0; }
        .left, .right { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        label { font-weight: 600; }
        select, input[type="text"] { padding: 10px 12px; font-size: 16px; border-radius: 10px; border: 1px solid var(--border); background: #fff; min-width: 160px; }
        button { padding: 10px 14px; font-size: 15px; border: none; border-radius: 12px; color: #fff; cursor: pointer; transition: filter .15s ease; display: inline-flex; align-items: center; gap: 8px; }
        .refresh-btn { background: var(--ok); }
        .export-btn { background: var(--info); }
        .clear-btn { background: var(--danger); }
        .btn-details { background-color: #6c757d; font-size: 14px; padding: 6px 12px; }
        .table-wrap { border: 1px solid var(--border); border-radius: 12px; overflow: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        thead th { position: sticky; top: 0; background: var(--brand-2); color: #fff; text-align: left; padding: 12px; font-weight: 700; }
        tbody td { padding: 12px; border-top: 1px solid var(--border); }
        tbody tr:nth-child(even) { background: #fafafa; }
        .rank { font-weight: 800; }
        .footer { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-top: 12px; flex-wrap: wrap; color: var(--muted); }
        .pagination { display: flex; gap: 6px; }
        .page-btn { background: #e5e7eb; color: #111827; border: none; border-radius: 10px; padding: 6px 10px; cursor: pointer; }
        .page-btn[aria-current="page"] { background: var(--brand-2); color: #fff; }
        .sortable { cursor: pointer; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #fff; padding: 25px; border-radius: 8px; width: 90%; max-width: 600px; z-index: 101; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
        .modal-close { font-size: 24px; font-weight: bold; cursor: pointer; border: none; background: none; padding: 0; }
        .modal-body { padding-top: 15px; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="/geetham.jpg" alt="Geetham Institute Logo" class="logo" />
            <h1>Student Results Dashboard</h1>
        </div>
        <div class="toolbar">
            <div class="left">
                <label for="search">Search:</label>
                <input id="search" type="text" placeholder="Name or Mobile‚Ä¶" />
                <label for="per-page">Rows:</label>
                <select id="per-page">
                    <option>10</option>
                    <option selected>25</option>
                    <option>50</option>
                </select>
            </div>
            <div class="right">
                <button class="refresh-btn" id="refreshBtn">‚ü≥ Refresh</button>
                <button class="export-btn" id="exportBtn">‚¨á Export CSV</button>
                <button class="clear-btn" id="clearBtn">üóë Clear All</button>
            </div>
        </div>
        <div id="msg" style="display:none"></div>
        <div class="table-wrap">
            <table id="results-table">
                <thead>
                    <!-- Headers are generated dynamically -->
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="footer">
            <div id="count"></div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <div id="details-modal" class="modal-backdrop" onclick="closeDetailsModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modal-title">Detailed Report</h3>
                <button class="modal-close" onclick="closeDetailsModal()">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>

<script>
(function() {
    let allResults = [];
    let filtered = [];
    let dynamicSubjects = [];
    let sortKey = 'totalScore';
    let sortDir = 'desc';
    let page = 1;
    let perPage = 25;

    const tbody = document.querySelector('#results-table tbody');
    const thead = document.querySelector('#results-table thead');
    const perPageEl = document.getElementById('per-page');
    const searchEl = document.getElementById('search');
    const msgEl = document.getElementById('msg');
    const countEl = document.getElementById('count');
    const pagination = document.getElementById('pagination');

    function normalizeRecord(r) {
        const total = Number(r.totalScore ?? 0);
        return {
            studentName: r.studentName || 'N/A',
            mobile: r.mobile || 'N/A',
            class: String(r.class || 'N/A'),
            subjectScores: r.subjectScores || {},
            totalScore: total,
            warnings: Number(r.warnings ?? 0),
            questionTimes: r.questionTimes || {}
        };
    }

    function computeRanks(arr) {
        const sorted = [...arr].sort((a, b) => b.totalScore - a.totalScore);
        const scoreToRank = new Map();
        sorted.forEach((item, index) => {
            if (!scoreToRank.has(item.totalScore)) {
                scoreToRank.set(item.totalScore, index + 1);
            }
        });
        return arr.map(it => ({...it, rank: scoreToRank.get(it.totalScore) }));
    }

    function applyFiltersAndRender() {
        const term = searchEl.value.trim().toLowerCase();
        filtered = allResults.filter(r => !term || r.studentName.toLowerCase().includes(term) || r.mobile.includes(term));
        
        filtered.sort((a, b) => {
            const valA = a[sortKey];
            const valB = b[sortKey];
            const comparison = typeof valA === 'number' ? valA - valB : String(valA).localeCompare(String(valB));
            return sortDir === 'asc' ? comparison : -comparison;
        });

        renderTable(computeRanks(filtered));
    }

    function renderTable(data) {
        // Dynamically find all unique subject names from the results
        const subjectSet = new Set();
        allResults.forEach(res => {
            if (res.subjectScores) {
                Object.keys(res.subjectScores).forEach(subject => subjectSet.add(subject));
            }
        });
        dynamicSubjects = Array.from(subjectSet).sort();

        // Create table headers dynamically
        let headerHTML = '<tr><th class="sortable" data-key="rank">Rank ‚¨ç</th><th class="sortable" data-key="studentName">Student Name ‚¨ç</th><th class="sortable" data-key="mobile">Mobile ‚¨ç</th><th class="sortable" data-key="totalScore">Total Score ‚¨ç</th>';
        dynamicSubjects.forEach(subject => {
            headerHTML += `<th>${subject}</th>`;
        });
        headerHTML += '<th class="sortable" data-key="warnings">Warnings ‚¨ç</th><th>Details</th></tr>';
        thead.innerHTML = headerHTML;
        addSortListeners(); // Re-add listeners to new headers

        perPage = Number(perPageEl.value);
        const total = data.length;
        const totalPages = Math.max(1, Math.ceil(total / perPage));
        if (page > totalPages) page = totalPages;
        const start = (page - 1) * perPage;
        const slice = data.slice(start, start + perPage);

        tbody.innerHTML = '';
        slice.forEach(res => {
            const row = tbody.insertRow();
            const resultString = encodeURIComponent(JSON.stringify(res));
            let rowHTML = `
                <td class="rank">${res.rank}</td>
                <td>${res.studentName}</td>
                <td>${res.mobile}</td>
                <td><strong>${res.totalScore}</strong></td>
            `;
            dynamicSubjects.forEach(subject => {
                rowHTML += `<td>${res.subjectScores[subject] ?? 0}</td>`;
            });
            rowHTML += `<td>${res.warnings}</td><td><button class="btn-details" onclick='showDetailsModal(JSON.parse(decodeURIComponent("${resultString}")))'>View</button></td>`;
            row.innerHTML = rowHTML;
        });
        countEl.textContent = `Showing ${slice.length} of ${total} results`;
        renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
        pagination.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.className = 'page-btn';
            btn.textContent = i;
            if (i === page) btn.setAttribute('aria-current', 'page');
            btn.onclick = () => { page = i; applyFiltersAndRender(); };
            pagination.appendChild(btn);
        }
    }

    async function fetchResults() {
        msgEl.style.display = 'block';
        msgEl.textContent = 'Loading...';
        try {
            const response = await fetch('/results');
            const data = await response.json();
            allResults = data.map(normalizeRecord);
            applyFiltersAndRender();
            msgEl.style.display = 'none';
        } catch (err) {
            msgEl.textContent = 'Error fetching results.';
        }
    }

    function exportToCSV() {
        const headers = ["Rank", "Student Name", "Mobile", "Total Score", ...dynamicSubjects, "Warnings"];
        const dataToExport = computeRanks(filtered);
        let csvContent = headers.join(",") + "\n";
        dataToExport.forEach(res => {
            const rowData = [res.rank, res.studentName, res.mobile, res.totalScore];
            dynamicSubjects.forEach(subject => rowData.push(res.subjectScores[subject] ?? 0));
            rowData.push(res.warnings);
            csvContent += rowData.map(val => `"${String(val).replace(/"/g, '""')}"`).join(",") + "\n";
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.setAttribute("href", URL.createObjectURL(blob));
        link.setAttribute("download", "geetham_e-exam_results.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    async function clearResults() {
        if (confirm("Are you sure you want to delete all results?")) {
            await fetch('/clear-results', { method: 'POST' });
            fetchResults();
        }
    }

    function addSortListeners() {
        document.querySelectorAll('th.sortable').forEach(th => {
            th.onclick = () => {
                const key = th.dataset.key;
                if (sortKey === key) {
                    sortDir = sortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    sortKey = key;
                    sortDir = 'desc';
                }
                applyFiltersAndRender();
            };
        });
    }

    window.showDetailsModal = function(result) {
        const modal = document.getElementById('details-modal');
        document.getElementById('modal-title').textContent = `Report for ${result.studentName}`;
        const modalBody = document.getElementById('modal-body');
        let detailsHTML = '<h4>Subject Scores:</h4><ul>';
        Object.keys(result.subjectScores).forEach(subject => {
            detailsHTML += `<li><strong>${subject}:</strong> ${result.subjectScores[subject]}</li>`;
        });
        detailsHTML += '</ul><hr>';
        if (result.questionTimes) {
            detailsHTML += '<h4>Time Per Question (seconds):</h4>';
            Object.keys(result.questionTimes).forEach(subject => {
                detailsHTML += `<strong>${subject}:</strong><ul>`;
                Object.keys(result.questionTimes[subject]).forEach(qIndex => {
                    detailsHTML += `<li>Question ${parseInt(qIndex) + 1}: ${result.questionTimes[subject][qIndex]}s</li>`;
                });
                detailsHTML += '</ul>';
            });
        }
        modalBody.innerHTML = detailsHTML;
        modal.style.display = 'flex';
    }
    window.closeDetailsModal = function() {
        document.getElementById('details-modal').style.display = 'none';
    }

    perPageEl.addEventListener('change', () => { page = 1; applyFiltersAndRender(); });
    searchEl.addEventListener('input', () => { page = 1; applyFiltersAndRender(); });
    document.getElementById('refreshBtn').addEventListener('click', fetchResults);
    document.getElementById('exportBtn').addEventListener('click', exportToCSV);
    document.getElementById('clearBtn').addEventListener('click', clearResults);

    fetchResults();
})();
</script>
</body>
</html>
