<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geetham e-Exam</title>
    
    <!-- TensorFlow.js Core and Backend -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>

    <!-- Face Landmarker Model -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>

    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #f0f2f5; 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .camera-wrapper { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            width: 200px; 
            height: 150px; 
            border: 3px solid #007bff; 
            border-radius: 8px; 
            background: #000; 
            overflow: hidden; 
            z-index: 1000; 
        }
        .camera-header { 
            height: 25px; 
            background: #007bff; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 10px; 
            font-size: 12px; 
        }
        .camera-view { 
            width: 100%; 
            height: calc(100% - 25px); 
            object-fit: cover; 
        }
        .warning { 
            background: #dc3545; 
            color: white; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0; 
        }
        .success { 
            background: #28a745; 
            color: white; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0; 
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #0056b3; }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            background: #f8f9fa; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Proctored Exam System</h1>
        
        <div class="status" id="status">
            <strong>Status:</strong> <span id="status-text">Initializing...</span>
        </div>
        
        <div class="warning" id="warning" style="display: none;">
            <strong>Warning:</strong> <span id="warning-text"></span>
        </div>
        
        <div class="success" id="success" style="display: none;">
            <strong>Success:</strong> <span id="success-text"></span>
        </div>
        
        <div>
            <button id="start-camera">Start Camera</button>
            <button id="start-proctoring">Start AI Proctoring</button>
            <button id="stop-proctoring">Stop Proctoring</button>
            <button id="fullscreen">Go Fullscreen</button>
        </div>
        
        <div style="margin-top: 20px;">
            <h3>Proctoring Features:</h3>
            <ul>
                <li>Face detection and gaze tracking</li>
                <li>Tab switching detection</li>
                <li>Fullscreen enforcement</li>
                <li>Camera visibility monitoring</li>
                <li>Warning system with auto-submission</li>
            </ul>
        </div>
    </div>

    <div class="camera-wrapper" id="camera-wrapper" style="display: none;">
        <div class="camera-header">
            <span>AI Proctor Camera</span>
            <button id="minimize-camera" style="background: transparent; border: none; color: white; cursor: pointer;">âˆ’</button>
        </div>
        <video id="camera-view" class="camera-view" autoplay playsinline muted></video>
    </div>

    <script>
        // Global variables
        let gazeModel = null;
        let isProctoringActive = false;
        let warningCount = 0;
        const maxWarnings = 3;
        let lookAwayStartTime = null;
        const LOOK_AWAY_THRESHOLD = 3000; // 3 seconds
        let proctoringInterval = null;

        // Initialize TensorFlow.js
        async function initializeTensorFlow() {
            try {
                updateStatus("Initializing TensorFlow.js...");
                
                // Set backend to WebGL for better performance
                await tf.setBackend('webgl');
                await tf.ready();
                
                updateStatus("TensorFlow.js initialized successfully");
                return true;
            } catch (error) {
                console.error("TensorFlow initialization failed:", error);
                updateStatus("TensorFlow.js initialization failed: " + error.message);
                return false;
            }
        }

        // Load the face detection model
        async function loadFaceModel() {
            try {
                updateStatus("Loading face detection model...");
                
                const model = faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh;
                const detectorConfig = {
                    runtime: 'mediapipe',
                    solutionPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh',
                    refineLandmarks: true
                };
                
                gazeModel = await faceLandmarksDetection.createDetector(model, detectorConfig);
                updateStatus("Face detection model loaded successfully");
                return true;
            } catch (error) {
                console.error("Face model loading failed:", error);
                updateStatus("Face model loading failed: " + error.message);
                return false;
            }
        }

        // Start camera
        async function startCamera() {
            try {
                updateStatus("Starting camera...");
                
                const videoElement = document.getElementById('camera-view');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 },
                        facingMode: 'user'
                    } 
                });
                
                videoElement.srcObject = stream;
                document.getElementById('camera-wrapper').style.display = 'block';
                
                updateStatus("Camera started successfully");
                showSuccess("Camera is now active");
                
                return true;
            } catch (error) {
                console.error("Camera start failed:", error);
                updateStatus("Camera start failed: " + error.message);
                return false;
            }
        }

        // Start AI proctoring
        async function startProctoring() {
            if (!gazeModel) {
                showWarning("Face detection model not loaded. Please wait...");
                return;
            }
            
            if (isProctoringActive) {
                showWarning("Proctoring is already active");
                return;
            }
            
            isProctoringActive = true;
            updateStatus("AI proctoring started - monitoring gaze and behavior");
            showSuccess("AI proctoring is now active");
            
            // Start gaze detection loop
            startGazeDetection();
            
            // Setup other monitoring
            setupTabSwitchDetection();
            setupFullscreenMonitoring();
        }

        // Stop AI proctoring
        function stopProctoring() {
            isProctoringActive = false;
            if (proctoringInterval) {
                clearInterval(proctoringInterval);
                proctoringInterval = null;
            }
            updateStatus("AI proctoring stopped");
        }

        // Gaze detection function
        function startGazeDetection() {
            const videoElement = document.getElementById('camera-view');
            
            async function detectGaze() {
                if (!isProctoringActive || !gazeModel) return;
                
                try {
                    const faces = await gazeModel.estimateFaces(videoElement, { 
                        flipHorizontal: false 
                    });
                    
                    if (faces.length > 0) {
                        const keypoints = faces[0].keypoints;
                        
                        // Get key facial landmarks
                        const leftEye = keypoints[33];  // Left eye center
                        const rightEye = keypoints[263]; // Right eye center
                        const nose = keypoints[1];       // Nose tip
                        
                        if (leftEye && rightEye && nose) {
                            // Calculate eye center
                            const eyeCenterX = (leftEye.x + rightEye.x) / 2;
                            const eyeCenterY = (leftEye.y + rightEye.y) / 2;
                            
                            // Calculate gaze direction relative to screen center
                            const screenCenterX = window.innerWidth / 2;
                            const screenCenterY = window.innerHeight / 2;
                            
                            const gazeOffsetX = Math.abs(eyeCenterX - screenCenterX);
                            const gazeOffsetY = Math.abs(eyeCenterY - screenCenterY);
                            
                            // Check if looking away (threshold can be adjusted)
                            if (gazeOffsetX > 100 || gazeOffsetY > 100) {
                                if (lookAwayStartTime === null) {
                                    lookAwayStartTime = Date.now();
                                } else if (Date.now() - lookAwayStartTime > LOOK_AWAY_THRESHOLD) {
                                    handleWarning("You are looking away from the screen for too long");
                                    lookAwayStartTime = null;
                                }
                            } else {
                                lookAwayStartTime = null;
                            }
                        }
                    } else {
                        // No face detected
                        if (lookAwayStartTime === null) {
                            lookAwayStartTime = Date.now();
                        } else if (Date.now() - lookAwayStartTime > LOOK_AWAY_THRESHOLD) {
                            handleWarning("No face detected - please return to camera view");
                            lookAwayStartTime = null;
                        }
                    }
                } catch (error) {
                    console.error("Gaze detection error:", error);
                }
                
                // Continue detection loop
                if (isProctoringActive) {
                    requestAnimationFrame(detectGaze);
                }
            }
            
            detectGaze();
        }

        // Handle warnings
        function handleWarning(message) {
            warningCount++;
            const warningMessage = `Warning ${warningCount}/${maxWarnings}: ${message}`;
            showWarning(warningMessage);
            
            if (warningCount >= maxWarnings) {
                showWarning("Maximum warnings exceeded. Exam will be submitted automatically.");
                setTimeout(() => {
                    stopProctoring();
                    alert("Exam terminated due to multiple violations.");
                }, 2000);
            }
        }

        // Tab switch detection
        function setupTabSwitchDetection() {
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && isProctoringActive) {
                    handleWarning("Tab switching detected");
                }
            });
        }

        // Fullscreen monitoring
        function setupFullscreenMonitoring() {
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement && isProctoringActive) {
                    handleWarning("Fullscreen exited");
                }
            });
        }

        // Go fullscreen
        async function goFullscreen() {
            try {
                if (document.documentElement.requestFullscreen) {
                    await document.documentElement.requestFullscreen();
                    showSuccess("Fullscreen mode activated");
                }
            } catch (error) {
                showWarning("Fullscreen request failed: " + error.message);
            }
        }

        // Utility functions
        function updateStatus(message) {
            document.getElementById('status-text').textContent = message;
            console.log("Status:", message);
        }

        function showWarning(message) {
            document.getElementById('warning-text').textContent = message;
            document.getElementById('warning').style.display = 'block';
            document.getElementById('success').style.display = 'none';
            console.warn("Warning:", message);
        }

        function showSuccess(message) {
            document.getElementById('success-text').textContent = message;
            document.getElementById('success').style.display = 'block';
            document.getElementById('warning').style.display = 'none';
            console.log("Success:", message);
        }

        // Event listeners
        document.getElementById('start-camera').addEventListener('click', startCamera);
        document.getElementById('start-proctoring').addEventListener('click', startProctoring);
        document.getElementById('stop-proctoring').addEventListener('click', stopProctoring);
        document.getElementById('fullscreen').addEventListener('click', goFullscreen);
        
        document.getElementById('minimize-camera').addEventListener('click', () => {
            const wrapper = document.getElementById('camera-wrapper');
            if (wrapper.style.width === '60px') {
                wrapper.style.width = '200px';
                wrapper.style.height = '150px';
            } else {
                wrapper.style.width = '60px';
                wrapper.style.height = '45px';
            }
        });

        // Initialize on page load
        window.addEventListener('load', async () => {
            updateStatus("Page loaded, initializing...");
            
            // Initialize TensorFlow first
            const tfReady = await initializeTensorFlow();
            if (tfReady) {
                // Load face model
                await loadFaceModel();
                updateStatus("System ready - you can start the camera and proctoring");
            }
        });

        // Prevent right-click and other shortcuts
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && (e.key === 'u' || e.key === 'U')) {
                e.preventDefault();
                handleWarning("View source attempt detected");
            }
            if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) {
                e.preventDefault();
                handleWarning("Developer tools access attempt detected");
            }
        });
    </script>
</body>
</html>
