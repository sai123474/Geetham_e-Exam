<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Geetham e-Exam</title>
    <link rel="icon" type="image/jpeg" href="/geetham.jpg" />
    <!-- Accessibility improvements -->
    <meta name="description" content="Geetham e-Exam platform for online assessments" />
    <meta name="theme-color" content="#0056b3" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"></script>
    <style>
        :root {
            --primary-color: #0056b3;
            --primary-light: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --text-color: #333;
            --text-light: #6c757d;
            --bg-color: #f0f2f5;
            --card-bg: #fff;
            --border-color: #ddd;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --border-radius: 8px;
            --focus-ring: 0 0 0 3px rgba(0,123,255,0.25);
        }
        
        /* Base styles with accessibility improvements */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 10px;
            line-height: 1.5;
            font-size: 16px;
        }
        
        /* Screen reader only class */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* Container layouts */
        .main-container, #student-details-screen { display: none; }
        .main-container.active { display: flex; }
        #student-details-screen.active { display: block; }
        .quiz-panel { 
            flex-grow: 1; 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow); 
        }
        .sidebar { 
            width: 300px; 
            margin-left: 20px; 
            background: var(--card-bg); 
            padding: 15px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow); 
            align-self: flex-start; 
        }
        
        /* Typography */
        h1, h2 { 
            color: var(--primary-color); 
            text-align: center;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        
        /* Form elements with accessibility improvements */
        input, select, button { 
            font-family: inherit;
            font-size: 16px; /* Prevent zoom on mobile */
        }
        
        input, select { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border: 1px solid var(--border-color); 
            border-radius: var(--border-radius); 
            box-sizing: border-box; 
        }
        
        input:focus, select:focus, button:focus {
            outline: none;
            box-shadow: var(--focus-ring);
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        /* Timer */
        #timer { 
            font-size: 20px; 
            font-weight: bold; 
            color: var(--danger-color); 
            text-align: center; 
            margin-bottom: 15px; 
        }
        
        /* Subject tabs with improved scrolling */
        .subject-tabs { 
            display: flex; 
            border-bottom: 2px solid var(--border-color); 
            margin-bottom: 20px; 
            gap: 10px; 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-light) var(--bg-color);
            padding-bottom: 5px;
        }
        
        .subject-tabs::-webkit-scrollbar {
            height: 6px;
        }
        
        .subject-tabs::-webkit-scrollbar-track {
            background: var(--bg-color);
        }
        
        .subject-tabs::-webkit-scrollbar-thumb {
            background-color: var(--primary-light);
            border-radius: 20px;
        }
        
        .subject-tab { 
            padding: 10px 20px; 
            cursor: pointer; 
            font-weight: 600; 
            border: none; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            font-size: 16px; 
            border-radius: 8px 8px 0 0; 
            white-space: nowrap;
            transition: background-color 0.2s, color 0.2s;
        }
        
        .subject-tab.active { 
            background-color: var(--primary-light); 
            color: white; 
        }
        
        .subject-tab:hover:not(.active) {
            background-color: rgba(0, 123, 255, 0.1);
        }
        
        /* Question area */
        .question-area { 
            min-height: 300px;
            padding: 10px;
            border-radius: var(--border-radius);
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        /* Options with improved accessibility */
        .option { 
            display: block; 
            margin: 10px 0; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            transition: all 0.2s ease; 
            position: relative;
        }
        
        .option:hover { 
            background-color: rgba(0, 123, 255, 0.05);
            border-color: var(--primary-light);
        }
        
        .option.selected { 
            background-color: var(--primary-light); 
            color: white; 
            border-color: var(--primary-light); 
        }
        
        .option:focus {
            outline: none;
            box-shadow: var(--focus-ring);
        }
        
        /* Navigation buttons */
        .nav-buttons { 
            margin-top: 20px; 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: space-between; 
            gap: 10px; 
        }
        
        button { 
            background-color: var(--primary-light); 
            color: white; 
            padding: 12px 20px; 
            border: none; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        button:hover {
            background-color: #0069d9;
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        button:disabled { 
            background-color: var(--text-light);
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* Question palette */
        .palette-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); 
            gap: 10px; 
        }
        
        .palette-item { 
            width: 40px; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
            cursor: pointer; 
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        .palette-item:hover {
            transform: scale(1.1);
        }
        
        .status-not-answered { background-color: #f0f0f0; }
        .status-answered { background-color: var(--success-color); color: white; }
        .status-review { background-color: var(--warning-color); }
        
        /* Camera */
        #camera-wrapper { 
            position: fixed; 
            bottom: 10px; 
            left: 10px; 
            width: 160px; 
            height: 120px; 
            border: 2px solid var(--primary-color); 
            border-radius: var(--border-radius); 
            background: #000; 
            overflow: hidden; 
            display: none; 
            z-index: 9998; 
            resize: both;
            box-shadow: var(--shadow);
        }
        
        #camera-header { 
            height: 22px; 
            background: rgba(0,86,179,0.9); 
            color: #fff; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 0 6px; 
            cursor: move; 
            font-size: 12px; 
        }
        
        #camera-view { 
            width: 100%; 
            height: calc(100% - 22px); 
            object-fit: cover; 
            display: block; 
        }
        
        /* Toast notifications */
        .toast { 
            position: fixed; 
            top: -100px; 
            left: 50%; 
            transform: translateX(-50%); 
            padding: 15px 25px; 
            border-radius: var(--border-radius); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
            font-size: 16px; 
            font-weight: bold; 
            z-index: 100000; 
            opacity: 0; 
            transition: opacity 0.5s, top 0.5s;
            max-width: 90%;
            word-wrap: break-word;
        }
        
        .toast.show { 
            top: 40px; 
            opacity: 1; 
        }
        
        .toast.warning { 
            background-color: var(--danger-color); 
            color: white; 
        }
        
        .toast.success { 
            background-color: var(--success-color); 
            color: white; 
        }
        
        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Fullscreen warning */
        #fullscreen-warning {
            background: rgba(0,0,0,0.9) !important;
        }
        
        /* Responsive design improvements */
        @media (max-width: 900px) {
            body { padding: 5px; }
            .main-container { flex-direction: column; }
            .sidebar { 
                width: 100%; 
                margin-left: 0; 
                margin-top: 20px; 
                box-sizing: border-box; 
            }
            .nav-buttons { 
                flex-direction: column; 
                align-items: stretch; 
            }
            .nav-buttons > div { 
                display: flex; 
                justify-content: space-between; 
                margin-top: 10px; 
                flex-wrap: wrap;
                gap: 5px;
            }
            .nav-buttons button { 
                padding: 12px 10px; 
                font-size: 14px;
                flex: 1;
                min-width: 80px;
            }
            .quiz-panel, .sidebar { padding: 15px; }
        }
        
        @media (max-width: 500px) {
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.3rem; }
            .toast { font-size: 14px; padding: 10px 15px; }
            .palette-item { width: 35px; height: 35px; font-size: 12px; }
            .palette-grid { gap: 5px; }
            .option { padding: 10px; }
            #timer { font-size: 18px; }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212;
                --card-bg: #1e1e1e;
                --text-color: #e0e0e0;
                --text-light: #a0a0a0;
                --border-color: #333;
                --shadow: 0 2px 8px rgba(0,0,0,0.3);
            }
            
            .status-not-answered { 
                background-color: #333; 
                color: #e0e0e0;
            }
            
            .option:hover:not(.selected) { 
                background-color: rgba(255, 255, 255, 0.05);
            }
            
            #fullscreen-warning {
                background: rgba(0,0,0,0.95) !important;
            }
        }
    </style>
</head>
<body>
    <div id="fullscreen-warning" style="display:none; flex-direction: column; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: white; z-index: 10000; text-align: center;">
        <h1>You Have Exited Full-Screen!</h1>
        <p>Please return to full-screen to continue the test. The test will be submitted if you fail to return.</p>
    </div>

    <div id="student-details-screen" class="active">
        <div style="max-width: 500px; margin: 50px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="text-align: center; margin-bottom: 15px;">
                <img src="/geetham.jpg" alt="Geetham Institute Logo" style="max-height: 80px;">
            </div>
            <h1>Geetham e-Exam</h1>
            <div id="login-form">
                <h2>Enter Your Details</h2>
                <div id="quiz-selection-container"></div>
                <input type="text" id="student-name" placeholder="Enter your full name" required autocomplete="off">
                <input type="tel" id="student-mobile" placeholder="Enter your mobile number" required autocomplete="off">
                <button id="proceed-btn" style="width: 100%;"><span id="proceed-btn-text">Proceed</span><span id="proceed-loading" class="loading" style="display:none;"></span></button>
            </div>
        </div>
    </div>

    <div class="main-container" id="quiz-screen">
        <div class="quiz-panel">
            <h1 style="margin-top: 0;" id="quiz-title-main"></h1>
            <div id="timer">00:00:00</div>
            <div class="subject-tabs"></div>
            <div id="question-area" class="question-area"></div>
            <div class="nav-buttons">
                <button onclick="markForReview()" aria-label="Mark question for review and go to next question">
                    <span aria-hidden="true">ðŸ”–</span> Mark for Review & Next
                </button>
                <div>
                    <button onclick="goPrevious()" aria-label="Go to previous question">
                        <span aria-hidden="true">â—€</span> Previous
                    </button>
                    <button onclick="clearResponse()" aria-label="Clear your answer">
                        <span aria-hidden="true">âœ–</span> Clear
                    </button>
                    <button onclick="saveAndNext()" aria-label="Save your answer and go to next question">
                        <span aria-hidden="true">â–¶</span> Save & Next
                    </button>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="submit" onclick="confirmSubmit()" style="background-color: var(--danger-color);" aria-label="Submit your test">
                    <span aria-hidden="true">âœ“</span> Submit Test
                </button>
            </div>
        </div>
        <div class="sidebar">
            <h4>Question Palette</h4>
            <div id="question-palette" class="palette-grid"></div>
            <hr>
            <h4>Legend</h4>
            <div style="display:flex; align-items: center; margin-top: 10px;"><div class="palette-item status-answered"></div><span style="margin-left: 10px;">Answered</span></div>
            <div style="display:flex; align-items: center; margin-top: 10px;"><div class="palette-item status-review"></div><span style="margin-left: 10px;">Marked for Review</span></div>
            <div style="display:flex; align-items: center; margin-top: 10px;"><div class="palette-item status-not-answered"></div><span style="margin-left: 10px;">Not Answered</span></div>
        </div>
        <div id="camera-wrapper">
            <div id="camera-header"><span>Camera</span></div>
            <video id="camera-view" autoplay playsinline muted></video>
        </div>
    </div>

<script type="module">
    import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js";

    // --- GLOBAL STATE ---
    let allQuizzes = [], currentQuiz = {}, currentSubject = "", currentQuestionIndex = 0;
    let userResponses = {}, studentDetails = {}, finalScores = {};
    let timerInterval, quizInProgress = false, warningCount = 0;
    const maxWarnings = 3;
    let faceLandmarker;

    // --- PROCTORING STATE ---
    let multiFaceCounter = 0;
    let noFaceCounter = 0;
    let eyeMovementCounter = 0;
    const MULTI_FACE_THRESHOLD = 20; // Stricter threshold - approx 1 second at moderate FPS
    const NO_FACE_THRESHOLD = 30; // Threshold for no face detection
    const EYE_MOVEMENT_THRESHOLD = 25; // Threshold for suspicious eye movements

    // --- UI HELPER ---
    function showToast(message, type = 'warning') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 500);
        }, 4000);
    }

    // --- PERMISSIONS & STARTUP FLOW ---
    async function startCamera() {
        const video = document.getElementById('camera-view');
        if (!navigator.mediaDevices?.getUserMedia) throw new Error("Camera not supported.");
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 160, height: 120 } });
        video.srcObject = stream;
        document.getElementById('camera-wrapper').style.display = 'block';
        await new Promise(resolve => video.onloadedmetadata = resolve);
    }
    
    function startExam(location) {
        studentDetails.location = location;
        document.getElementById('student-details-screen').classList.remove('active');
        document.getElementById('quiz-screen').classList.add('active');
        initializeQuiz();
    }

    // MANDATORY LOCATION CHECK
    function requestLocationAndStart() {
        if (!navigator.geolocation) return alert("Geolocation is not supported by your browser. You cannot proceed.");
        
        showToast("Please grant location permission to start the exam.", "success");
        navigator.geolocation.getCurrentPosition(
            async (position) => { // Success
                const location = { lat: position.coords.latitude, lon: position.coords.longitude };
                try {
                    await startCamera();
                    await document.documentElement.requestFullscreen();
                    showToast("Permissions granted! Starting exam...", "success");
                    setTimeout(() => startExam(location), 1500);
                } catch (err) {
                    alert("Could not start. Please allow both Camera and Fullscreen permissions.");
                }
            },
            () => { // Error
                alert("Location permission is REQUIRED to start the exam. Please enable it and try again.");
            }
        );
    }
    
    // --- PROCTORING LOGIC ---
    function handleWarning(message) {
        if (!quizInProgress) return;
        warningCount++;
        showToast(`Warning ${warningCount}/${maxWarnings}: ${message}`, 'warning');
        if (warningCount >= maxWarnings) {
            setTimeout(() => {
                showToast(`Maximum warnings exceeded. Submitting test automatically.`, 'warning');
                submitTest();
            }, 1000);
        }
    }

    async function setupProctoring() {
        try {
            const filesetResolver = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm");
            faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numFaces: 2
            });
            predictWebcam();
        } catch(e) {
            console.error("Failed to load proctoring model.", e);
        }
    }
    
    // ENHANCED PROCTORING DETECTION LOGIC
    function predictWebcam() {
        if (!quizInProgress || !faceLandmarker) return;
        const video = document.getElementById('camera-view');
        if (video.readyState >= 2) {
            const results = faceLandmarker.detectForVideo(video, performance.now());
            
            // Multiple face detection (stricter)
            if (results.faceLandmarks && results.faceLandmarks.length > 1) {
                multiFaceCounter++;
                if (multiFaceCounter >= MULTI_FACE_THRESHOLD) {
                    handleWarning("Multiple faces detected.");
                    multiFaceCounter = 0;
                }
            } else {
                multiFaceCounter = 0;
            }
            
            // No face detection
            if (!results.faceLandmarks || results.faceLandmarks.length === 0) {
                noFaceCounter++;
                if (noFaceCounter >= NO_FACE_THRESHOLD) {
                    handleWarning("No face detected. Please stay in front of the camera.");
                    noFaceCounter = 0;
                }
            } else {
                noFaceCounter = 0;
                
                // Eye movement detection (looking away from screen)
                const face = results.faceLandmarks[0];
                if (face) {
                    // Check if eyes are looking away from screen
                    // This is a simplified check - in a real implementation, you'd use more sophisticated eye tracking
                    const leftEye = face[33]; // Approximate left eye landmark
                    const rightEye = face[263]; // Approximate right eye landmark
                    
                    if (leftEye && rightEye) {
                        // Check if eyes are looking too far to the sides
                        const eyeXDiff = Math.abs(leftEye.x - rightEye.x);
                        const eyeYDiff = Math.abs(leftEye.y - rightEye.y);
                        
                        // If eyes are looking too far to the sides or up/down
                        if (eyeXDiff < 0.05 || eyeYDiff > 0.05) {
                            eyeMovementCounter++;
                            if (eyeMovementCounter >= EYE_MOVEMENT_THRESHOLD) {
                                handleWarning("Please look at the screen.");
                                eyeMovementCounter = 0;
                            }
                        } else {
                            eyeMovementCounter = 0;
                        }
                    }
                }
            }
        }
        window.requestAnimationFrame(predictWebcam);
    }
    
    function setupProctoringListeners() {
        // Full screen monitoring
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && quizInProgress) {
                handleWarning("You have exited full-screen.");
                document.getElementById('fullscreen-warning').style.display = 'flex';
                
                // Auto-attempt to return to fullscreen after warning
                setTimeout(() => {
                    if (!document.fullscreenElement) {
                        try {
                            document.documentElement.requestFullscreen();
                        } catch (e) {
                            console.error("Could not return to fullscreen:", e);
                        }
                    }
                }, 3000);
            } else {
                document.getElementById('fullscreen-warning').style.display = 'none';
            }
        });

        // Tab switching detection
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && quizInProgress) {
                handleWarning("You have switched tabs or minimized the window.");
            }
        });
        
        // Browser focus monitoring
        window.addEventListener('blur', () => {
            if (quizInProgress) {
                handleWarning("Browser window lost focus. Please stay in the exam window.");
            }
        });
        
        // Prevent right-click context menu
        document.addEventListener('contextmenu', (e) => {
            if (quizInProgress) {
                e.preventDefault();
                handleWarning("Right-clicking is not allowed during the exam.");
                return false;
            }
        });
        
        // Prevent keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (!quizInProgress) return;
            
            // Prevent Ctrl+C, Ctrl+V, Ctrl+P, Alt+Tab, etc.
            if ((e.ctrlKey && (e.key === 'c' || e.key === 'v' || e.key === 'p')) || 
                (e.altKey && e.key === 'Tab') ||
                (e.key === 'PrintScreen') ||
                (e.key === 'F12')) {
                e.preventDefault();
                handleWarning("Keyboard shortcuts are disabled during the exam.");
                return false;
            }
        });
    }

    // --- LOGIN & INITIALIZATION ---
    async function handleProceed() {
        studentDetails.name = document.getElementById('student-name').value.trim();
        studentDetails.mobile = document.getElementById('student-mobile').value.trim();
        const quizSelect = document.getElementById('quiz-select');
        currentQuiz = allQuizzes[quizSelect.value];

        if (!studentDetails.name || !studentDetails.mobile) {
            showToast("Please fill all details.", "warning");
            return;
        }
        
        // Show loading state
        const proceedBtn = document.getElementById('proceed-btn');
        const proceedBtnText = document.getElementById('proceed-btn-text');
        const proceedLoading = document.getElementById('proceed-loading');
        
        proceedBtn.disabled = true;
        proceedBtnText.textContent = "Verifying...";
        proceedLoading.style.display = "inline-block";
        
        try {
            const response = await fetch('/check-attempt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mobile: studentDetails.mobile, quizId: currentQuiz.id })
            });
            const data = await response.json();
            
            if (data.success && data.canAttempt) {
                document.getElementById('login-form').innerHTML = `<h2>Exam Instructions</h2>
                    <p>This test is AI-proctored. Do not switch tabs or exit full-screen.</p>
                    <p>Location and Camera access are mandatory.</p>
                    <div class="instruction-list">
                        <p><strong>Important Rules:</strong></p>
                        <ul>
                            <li>Stay in front of the camera at all times</li>
                            <li>No other person should be visible in the camera</li>
                            <li>Do not use any reference materials</li>
                            <li>Do not attempt to copy or share exam content</li>
                            <li>Complete the exam within the allotted time</li>
                        </ul>
                    </div>
                    <button id="start-test-btn" style="width:100%;">Grant Permissions & Start Exam</button>`;
                document.getElementById('start-test-btn').onclick = requestLocationAndStart;
            } else {
                showToast(data.message || "You have already attempted this quiz.", "warning");
            }
        } catch(e) {
            showToast('Could not verify attempt. Please check your connection.', "warning");
        } finally {
            // Reset button state
            proceedBtn.disabled = false;
            proceedBtnText.textContent = "Proceed";
            proceedLoading.style.display = "none";
        }
    }

    async function loadInitialData() {
        try {
            const response = await fetch('/get-quizzes');
            allQuizzes = await response.json();
            const quizSelectContainer = document.getElementById('quiz-selection-container');
            let selectHTML = '<label for="quiz-select">Select a Test:</label><select id="quiz-select">';
            allQuizzes.forEach((quiz, index) => selectHTML += `<option value="${index}">${quiz.title}</option>`);
            selectHTML += '</select>';
            quizSelectContainer.innerHTML = selectHTML;
            document.getElementById('proceed-btn').onclick = handleProceed;
        } catch (error) {
            document.body.innerHTML = "<h1>Error: Could not load quiz data from server.</h1>";
        }
    }
    
    // --- QUIZ ENGINE LOGIC ---
    function initializeQuiz() {
        quizInProgress = true;
        document.getElementById('quiz-title-main').textContent = currentQuiz.title;
        setupProctoring();
        setupProctoringListeners();

        Object.keys(currentQuiz.subjects).forEach(subject => {
            userResponses[subject] = {};
        });
        
        currentSubject = Object.keys(currentQuiz.subjects)[0];
        currentQuestionIndex = 0;
        
        renderTabs();
        loadQuestion();
        startTimer(currentQuiz.timeLimit * 60);
    }
    
    function renderTabs() {
        const tabsContainer = document.querySelector('.subject-tabs');
        tabsContainer.innerHTML = '';
        Object.keys(currentQuiz.subjects).forEach(subject => {
            const tab = document.createElement('button');
            tab.className = 'subject-tab';
            tab.textContent = subject;
            if (subject === currentSubject) tab.classList.add('active');
            tab.onclick = () => switchSubject(subject);
            tabsContainer.appendChild(tab);
        });
    }

    function switchSubject(subject) {
        currentSubject = subject;
        currentQuestionIndex = 0;
        renderTabs();
        loadQuestion();
    }

    function loadQuestion() {
        const question = currentQuiz.subjects[currentSubject][currentQuestionIndex];
        const questionArea = document.getElementById('question-area');
        questionArea.innerHTML = `<h3>Question ${currentQuestionIndex + 1} of ${currentQuiz.subjects[currentSubject].length}</h3><p>${question.text}</p><div id="options-container"></div>`;
        const optionsContainer = document.getElementById('options-container');

        if (!userResponses[currentSubject][currentQuestionIndex]) {
            userResponses[currentSubject][currentQuestionIndex] = {};
        }
        const response = userResponses[currentSubject][currentQuestionIndex];

        if (question.type === "multiple-choice") {
            if (!response.shuffledOptions) {
                const originalCorrectAnswerText = question.options[question.correctAnswer];
                const shuffledOptions = [...question.options];
                for (let i = shuffledOptions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
                }
                response.shuffledOptions = shuffledOptions;
                response.shuffledCorrectAnswerIndex = shuffledOptions.indexOf(originalCorrectAnswerText);
            }
            response.shuffledOptions.forEach((optionText, index) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.textContent = optionText;
                if (response.answer === index) div.classList.add('selected');
                div.onclick = () => selectOption(index);
                optionsContainer.appendChild(div);
            });
        } else if (question.type === "fill-in-the-blank") {
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Enter your answer';
            input.value = response.answer || '';
            input.oninput = (e) => selectOption(e.target.value);
            optionsContainer.appendChild(input);
        }
        updatePalette();
    }
    
    function selectOption(answer) {
        const response = userResponses[currentSubject][currentQuestionIndex];
        response.answer = answer;
        response.status = 'answered';
        
        if (currentQuiz.subjects[currentSubject][currentQuestionIndex].type === "multiple-choice") {
            document.querySelectorAll('.option').forEach((opt, idx) => {
                opt.classList.toggle('selected', idx === answer);
            });
        }
        updatePalette();
    }

    function updatePalette() {
        const palette = document.getElementById('question-palette');
        palette.innerHTML = '';
        let globalQIndex = 0;
        Object.keys(currentQuiz.subjects).forEach(subject => {
            currentQuiz.subjects[subject].forEach((q, qIndex) => {
                const item = document.createElement('div');
                item.className = 'palette-item';
                item.textContent = globalQIndex + 1;
                const status = userResponses[subject]?.[qIndex]?.status || 'not-answered';
                if (status === 'answered') item.classList.add('status-answered');
                else if (status === 'review') item.classList.add('status-review');
                else item.classList.add('status-not-answered');
                
                item.onclick = () => {
                    currentSubject = subject;
                    currentQuestionIndex = qIndex;
                    renderTabs();
                    loadQuestion();
                };
                palette.appendChild(item);
                globalQIndex++;
            });
        });
    }

    function startTimer(duration) {
        let timer = duration;
        const display = document.getElementById('timer');
        timerInterval = setInterval(() => {
            const hours = Math.floor(timer / 3600);
            const minutes = Math.floor((timer % 3600) / 60);
            const seconds = timer % 60;
            display.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (--timer < 0) {
                clearInterval(timerInterval);
                showToast("Time's up! Submitting your exam.", 'warning');
                submitTest();
            }
        }, 1000);
    }

    function goNext() {
        if (currentQuestionIndex < currentQuiz.subjects[currentSubject].length - 1) {
            currentQuestionIndex++;
        } else {
            const subjectKeys = Object.keys(currentQuiz.subjects);
            const currentSubIndex = subjectKeys.indexOf(currentSubject);
            if (currentSubIndex < subjectKeys.length - 1) {
                switchSubject(subjectKeys[currentSubIndex + 1]);
            } else {
                showToast("You are at the last question.", "success");
            }
        }
        loadQuestion();
    }
    function saveAndNext() { goNext(); }
    
    function goPrevious() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
        } else {
            const subjectKeys = Object.keys(currentQuiz.subjects);
            const currentSubIndex = subjectKeys.indexOf(currentSubject);
            if (currentSubIndex > 0) {
                currentSubject = subjectKeys[currentSubIndex - 1];
                currentQuestionIndex = currentQuiz.subjects[currentSubject].length - 1;
                renderTabs();
            }
        }
        loadQuestion();
    }

    function clearResponse() {
        const response = userResponses[currentSubject]?.[currentQuestionIndex];
        if (response) {
            delete response.answer;
            delete response.status;
        }
        loadQuestion(); // Reload to reflect the cleared answer
    }

    function markForReview() {
        const response = userResponses[currentSubject][currentQuestionIndex];
        response.status = 'review';
        goNext();
    }
    
    function submitTest() {
        if (!quizInProgress) return;
        quizInProgress = false;
        clearInterval(timerInterval);
        
        let totalScore = 0;
        let subjectScores = {};
        Object.keys(currentQuiz.subjects).forEach(subject => {
            let currentSubjectScore = 0;
            currentQuiz.subjects[subject].forEach((q, index) => {
                const response = userResponses[subject]?.[index];
                if (response?.status !== 'answered') return;

                const marksCorrect = (currentQuiz.marksMode === 'custom' ? q.correctMarks : currentQuiz.correctMarks) ?? 1;
                const marksIncorrect = (currentQuiz.marksMode === 'custom' ? q.wrongMarks : currentQuiz.wrongMarks) ?? 0;

                if (q.type === 'multiple-choice') {
                    if (response.answer === response.shuffledCorrectAnswerIndex) {
                        currentSubjectScore += marksCorrect;
                    } else {
                        currentSubjectScore += marksIncorrect;
                    }
                } else if (q.type === 'fill-in-the-blank') {
                    const correctAnswers = (q.answerKey || '').split('|').map(a => a.trim().toLowerCase());
                    const isCorrect = correctAnswers.includes(response.answer.toString().trim().toLowerCase());
                    currentSubjectScore += isCorrect ? marksCorrect : marksIncorrect;
                }
            });
            subjectScores[subject] = currentSubjectScore;
            totalScore += currentSubjectScore;
        });
        
        finalScores = { totalScore, subjectScores };

        const resultData = {
            studentName: studentDetails.name, mobile: studentDetails.mobile, location: studentDetails.location,
            quizId: currentQuiz.id, quizTitle: currentQuiz.title,
            totalScore, subjectScores, warnings: warningCount, responses: userResponses,
            date: new Date().toISOString()
        };

        fetch('/submit-result', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(resultData)
        }).then(res => {
            if (!res.ok) throw new Error('Submission failed');
            document.getElementById('quiz-screen').innerHTML = `<div style="text-align:center; margin: 50px auto;">
                <h1>Thank you!</h1>
                <p>Your exam has been submitted successfully.</p>
                <button onclick="downloadStudentReport()">Download Your Report</button>
            </div>`;
        }).catch(err => {
            alert('Submission failed. Your progress is saved. Please check your connection and contact support.');
        });
    }

    function confirmSubmit() {
        if (confirm("Are you sure you want to submit the test?")) {
            submitTest();
        }
    }
    
    function downloadStudentReport() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 20;

        doc.setFontSize(18); doc.setFont(undefined, 'bold');
        doc.text('Geetham e-Exam Report', doc.internal.pageSize.width / 2, y, { align: 'center' });
        y += 15;

        doc.setFontSize(12); doc.setFont(undefined, 'normal');
        doc.text(`Student Name: ${studentDetails.name}`, 15, y); y += 7;
        doc.text(`Mobile: ${studentDetails.mobile}`, 15, y); y += 10;
        doc.text(`Quiz Title: ${currentQuiz.title}`, 15, y); y += 7;
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 15, y); y += 15;
        
        doc.setLineWidth(0.5); doc.line(15, y, 195, y); y += 10;

        doc.setFontSize(14); doc.setFont(undefined, 'bold');
        doc.text('Performance Summary', 15, y); y += 10;
        
        doc.setFontSize(12); doc.setFont(undefined, 'normal');
        doc.text(`Final Score (Auto-Graded): ${finalScores.totalScore.toFixed(2)}`, 15, y); y += 7;
        doc.text(`Proctoring Warnings: ${warningCount}`, 15, y);
        
        doc.save(`${studentDetails.name}_Report.pdf`);
    }
    
    Object.assign(window, { markForReview, goPrevious, clearResponse, saveAndNext, confirmSubmit, downloadStudentReport });
    
    loadInitialData();
</script>
</body>
</html>
