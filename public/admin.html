<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - Geetham e-Exam</title>
    <link rel="icon" type="image/jpeg" href="/geetham.jpg">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; margin: 0; padding: 30px; }
        .container { max-width: 1200px; margin: auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { max-height: 80px; }
        h1, h3, h4, h5 { color: #0056b3; }
        .admin-panel { display: flex; gap: 30px; }
        .quiz-list { width: 300px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); align-self: flex-start; }
        .quiz-editor { flex-grow: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .quiz-list-item { padding: 15px; margin-bottom: 10px; border-radius: 6px; cursor: pointer; border: 1px solid #ddd; }
        .quiz-list-item.active { background-color: #e7f3ff; border-left: 4px solid #007bff; font-weight: bold; }
        label { font-weight: 600; color: #333; margin-top: 15px; display: block; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; font-size: 15px; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 12px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px; margin-top: 10px; }
        .btn-save { background-color: #28a745; }
        .btn-add { background-color: #17a2b8; }
        .btn-remove { background-color: #dc3545; padding: 5px 10px; font-size: 12px; }
        .btn-delete-quiz { background-color: #dc3545; }
        .btn-pdf { background-color: #ffc107; color: #212529; }
        .question-container, .subject-container { border: 1px solid #e9ecef; padding: 15px; margin-top: 15px; border-radius: 5px; background-color: #fdfdff; }
        .answer-fields input { margin-top: 5px; margin-bottom: 5px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <img src="/geetham.jpg" alt="Geetham Institute Logo" class="logo">
        <h1>Quiz Admin Panel</h1>
    </div>
    <div id="password-prompt">
        <input type="password" id="admin-password" placeholder="Enter Admin Password">
        <button onclick="login()">Login</button>
    </div>
    <div id="admin-panel" class="admin-panel" style="display:none;">
        <div class="quiz-list" id="quiz-list-panel"></div>
        <div class="quiz-editor" id="quiz-editor-panel"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const ADMIN_PASSWORD = "admin123";
let quizzesData = [];
let selectedQuizIndex = 0;
const AUTOSAVE_INTERVAL = 5000;
function login() {
    if (document.getElementById('admin-password').value === ADMIN_PASSWORD) {
        document.getElementById('password-prompt').style.display = 'none';
        document.getElementById('admin-panel').style.display = 'flex';
        loadQuizzes();
    } else alert('Incorrect password!');
}

async function loadQuizzes() {
    try {
        const response = await fetch('/get-quizzes');
        quizzesData = await response.json();
        renderQuizList();
        renderQuizEditor();
    } catch (error) {
        alert("Could not load quiz data from server.");
    }
}

function renderQuizList() {
    const listPanel = document.getElementById('quiz-list-panel');
    listPanel.innerHTML = '<h3>All Quizzes</h3>';
    quizzesData.forEach((quiz, index) => {
        const item = document.createElement('div');
        item.className = 'quiz-list-item' + (index === selectedQuizIndex ? ' active' : '');
        item.textContent = quiz.title;
        item.onclick = () => { selectedQuizIndex = index; renderQuizList(); renderQuizEditor(); };
        listPanel.appendChild(item);
    });
    const addBtn = document.createElement('button');
    addBtn.className = 'btn-add';
    addBtn.textContent = 'Add New Quiz';
    addBtn.onclick = addQuiz;
    listPanel.appendChild(addBtn);
}

function renderQuizEditor() {
    const editor = document.getElementById('quiz-editor-panel');
    const quiz = quizzesData[selectedQuizIndex];
    if (!quiz) { editor.innerHTML = '<h3>Select a quiz to edit or add new one.</h3>'; return; }
    editor.innerHTML = `
        <h3>Editing: ${quiz.title}</h3>
        <div id="quiz-details"></div>
        <div id="subjects-details"></div>
        <button class="btn-add" onclick="addSubject()">Add Subject</button>
        <div class="question-container" style="margin-top: 30px;">
            <h4>Generate Questions from Text using AI</h4>
            <textarea id="ai-text-input" rows="8" placeholder="Paste question paper text here..."></textarea>
            <button class="btn-add" onclick="generateFromText()">Generate from Text</button>
        </div>
        <div style="margin-top: 20px; display:flex; justify-content:space-between; flex-wrap: wrap;">
            <div>
                <button class="btn-save" onclick="saveQuiz()">Save This Quiz</button>
                <button class="btn-delete-quiz" onclick="deleteQuiz()">Delete This Quiz</button>
            </div>
            <button class="btn-pdf" onclick="generatePDF()">Download as PDF</button>
        </div>
    `;
    renderQuizDetails(quiz);
    renderSubjects(quiz.subjects);
}

function renderQuizDetails(quiz) {
    document.getElementById('quiz-details').innerHTML = `
        <label>Title:</label><input type="text" id="quiz-title" value="${quiz.title}">
        <label>Time Limit (minutes):</label><input type="number" id="quiz-time" value="${quiz.timeLimit}">
        <label>Class / Grade:</label>
<select id="quiz-class">
    ${[6,7,8,9,10,11,12].map(g => `<option value="${g}" ${quiz.class == g ? 'selected' : ''}>${g}th</option>`).join('')}
</select>

        <label>Password:</label><input type="text" id="quiz-password" value="${quiz.password}">
    `;
}

function renderSubjects(subjects) {
    const container = document.getElementById('subjects-details');
    container.innerHTML = '<h4>Subjects</h4>';
    Object.keys(subjects).forEach(subjectName => {
        const div = document.createElement('div');
        div.className = 'subject-container';
        div.innerHTML = `
            <label>Subject Name:</label>
            <input type="text" class="subject-name" value="${subjectName}">
            <button class="btn-remove" onclick="removeSubject(this)">Remove Subject</button>
            <div class="question-container">
                <h5>Generate Questions for ${subjectName} with AI</h5>
                <input type="text" id="topic-${subjectName}" placeholder="Enter topic">
                <input type="number" id="num-${subjectName}" value="3" style="width:80px">
                <button class="btn-add" onclick="generateWithAI('${subjectName}')">Generate</button>
            </div>
        `;
        subjects[subjectName].forEach((q, i) => div.appendChild(createQuestionElement(i, q)));
        const addBtn = document.createElement('button');
        addBtn.className = 'btn-add';
        addBtn.textContent = 'Add Question';
        addBtn.onclick = () => addQuestion(div);
        div.appendChild(addBtn);
        container.appendChild(div);
    });
}
// Load from localStorage on page load
document.addEventListener('DOMContentLoaded', () => {
    const savedData = localStorage.getItem('autosaveQuizzes');
    if (savedData) {
        if (confirm("Found unsaved changes from last session. Load them?")) {
            quizzesData = JSON.parse(savedData);
            renderQuizList();
            renderQuizEditor();
        } else {
            localStorage.removeItem('autosaveQuizzes');
        }
    }
});
    // Function to save current panel state to localStorage
function autosave() {
    if (quizzesData.length === 0) return;
    // Update the currently selected quiz details before saving
    const quiz = quizzesData[selectedQuizIndex];
    if (!quiz) return;
    
    quiz.title = document.getElementById('quiz-title')?.value || quiz.title;
    quiz.timeLimit = parseInt(document.getElementById('quiz-time')?.value) || quiz.timeLimit;
    quiz.password = document.getElementById('quiz-password')?.value || quiz.password;

    const newSubs = {};
    document.querySelectorAll('.subject-container').forEach(subDiv => {
        const name = subDiv.querySelector('.subject-name')?.value;
        if (!name) return;
        newSubs[name] = [];
        subDiv.querySelectorAll('.question-container').forEach(qDiv => {
            const type = qDiv.querySelector('.question-type')?.value || 'multiple-choice';
            const qData = { text: qDiv.querySelector('textarea')?.value || '', type };
            if (type === 'multiple-choice') {
                qData.options = Array.from(qDiv.querySelectorAll('.answer-fields input')).map(i => i.value);
                qData.correctAnswer = parseInt(qDiv.querySelector('.correct-answer-mc')?.value || 0, 10);
            } else {
                qData.correctAnswer = qDiv.querySelector('.correct-answer-text')?.value || '';
            }
            newSubs[name].push(qData);
        });
    });
    quiz.subjects = newSubs;

    localStorage.setItem('autosaveQuizzes', JSON.stringify(quizzesData));
    console.log("Autosaved at " + new Date().toLocaleTimeString());
}
    // Start autosave interval
setInterval(autosave, AUTOSAVE_INTERVAL);
function createQuestionElement(index, question) {
    const div = document.createElement('div');
    div.className = 'question-container';
    div.innerHTML = `
        <h5>Question ${index+1} <button class="btn-remove" onclick="removeQuestion(this)">Remove</button></h5>
        <label>Question Type:</label>
        <select class="question-type" onchange="toggleAnswerType(this)"></select>
        <label>Question Text:</label><textarea rows="2">${question.text}</textarea>
        <div class="answer-fields"></div>
    `;
    const select = div.querySelector('.question-type');
    ['multiple-choice','fill-in-the-blank','subjective'].forEach(t=>{
        const opt = document.createElement('option');
        opt.value=t; opt.textContent=t.replace(/-/g,' ');
        if(t===question.type) opt.selected=true;
        select.appendChild(opt);
    });
    toggleAnswerType(select, div.querySelector('.answer-fields'), question);
    return div;
}

function toggleAnswerType(select, container, question={}) {
    if(!container) container=select.closest('.question-container').querySelector('.answer-fields');
    const type = select.value;
    if(type==='multiple-choice') {
        container.innerHTML='';
        for(let i=0;i<4;i++){
            const input=document.createElement('input');
            input.type='text';
            input.value=question.options?.[i]||'';
            container.appendChild(input);
        }
        const correct=document.createElement('select');
        correct.className='correct-answer-mc';
        for(let i=0;i<4;i++){
            const opt=document.createElement('option');
            opt.value=i; opt.textContent='Option '+(i+1);
            if(question.correctAnswer===i) opt.selected=true;
            correct.appendChild(opt);
        }
        container.appendChild(correct);
    } else {
        container.innerHTML=`<input type="text" class="correct-answer-text" value="${question.correctAnswer||''}">`;
    }
}

function addQuiz() {
    quizzesData.push({id:Date.now(),title:"New Mock Test",timeLimit:180,password:"newpass",subjects:{}});
    selectedQuizIndex=quizzesData.length-1;
    renderQuizList(); renderQuizEditor();
}

function addSubject() {
    const name=prompt("Enter new subject name:");
    if(!name) return;
    if(quizzesData[selectedQuizIndex].subjects[name]) { alert("Subject exists!"); return; }
    quizzesData[selectedQuizIndex].subjects[name]=[];
    renderQuizEditor();
}

function removeSubject(btn) {
    if(confirm("Remove this subject?")) {
        const subDiv=btn.closest('.subject-container');
        const name=subDiv.querySelector('.subject-name').value;
        delete quizzesData[selectedQuizIndex].subjects[name];
        subDiv.remove();
    }
}

function addQuestion(subjectDiv) {
    const questions = subjectDiv.querySelectorAll('.question-container');
    const qIndex = questions.length;

    // Create a new question object
    const newQuestion = {
        type: 'multiple-choice',
        text: 'New Question',
        options: ["", "", "", ""],
        correctAnswer: 0
    };

    const newQuestionElement = createQuestionElement(qIndex, newQuestion);

    // Append the new question before the last "Add Question" button if exists
    const addButton = Array.from(subjectDiv.querySelectorAll('button')).find(btn => btn.textContent.includes('Add Question'));
    if (addButton && addButton.parentNode === subjectDiv) {
        subjectDiv.insertBefore(newQuestionElement, addButton);
    } else {
        subjectDiv.appendChild(newQuestionElement);
    }
}


function removeQuestion(btn){btn.closest('.question-container').remove();}

async function generateWithAI(subjectName){
    const topic=document.getElementById(`topic-${subjectName}`).value;
    const num=parseInt(document.getElementById(`num-${subjectName}`).value);
    if(!topic) return alert("Enter topic!");
    try{
        const res=await fetch('/generate-questions',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({topic,numQuestions:num})});
        const newQs=await res.json();
        quizzesData[selectedQuizIndex].subjects[subjectName].push(...newQs);
        renderQuizEditor(); alert(`${newQs.length} questions added to ${subjectName}!`);
    }catch(e){alert("AI generation failed");}
}

async function generateFromText(){
    const text=document.getElementById('ai-text-input').value.trim();
    if(!text) return alert("Paste text first!");
    try{
        const res=await fetch('/generate-from-text',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
        const newQs=await res.json();
        newQs.forEach(q=>{ if(quizzesData[selectedQuizIndex].subjects[q.subject]) quizzesData[selectedQuizIndex].subjects[q.subject].push(q); });
        renderQuizEditor(); alert(`${newQs.length} questions added!`);
    }catch(e){alert("Failed to generate from text");}
}

async function deleteQuiz(){
    if(confirm(`Delete "${quizzesData[selectedQuizIndex].title}"?`)){
        quizzesData.splice(selectedQuizIndex,1);
        await saveAllQuizzesToServer();
        selectedQuizIndex=0;
        loadQuizzes();
    }
}

async function saveQuiz() {
    const quizToSave = quizzesData[selectedQuizIndex];
    if (!quizToSave) return;

    // Save main quiz details safely
    quizToSave.title = document.getElementById('quiz-title')?.value || quizToSave.title;
    quizToSave.timeLimit = parseInt(document.getElementById('quiz-time')?.value) || quizToSave.timeLimit;
    quizToSave.class = document.getElementById('quiz-class').value;
    quizToSave.password = document.getElementById('quiz-password')?.value || quizToSave.password;

    const newSubjects = {};

    // Loop through all subjects
    document.querySelectorAll('.subject-container').forEach(subjectDiv => {
        const subjectNameInput = subjectDiv.querySelector('.subject-name');
        if (subjectNameInput && subjectNameInput.value) {
            const subjectName = subjectNameInput.value;
            newSubjects[subjectName] = [];

            // Loop through all questions inside the subject
            subjectDiv.querySelectorAll('.question-container').forEach(qDiv => {
                const type = qDiv.querySelector('.question-type')?.value || 'multiple-choice';
                const questionData = {
                    text: qDiv.querySelector('textarea')?.value || '',
                    type
                };

                if (type === 'multiple-choice') {
                    const optionInputs = qDiv.querySelectorAll('.answer-fields input');
                    questionData.options = Array.from(optionInputs).map(input => input.value || '');
                    questionData.correctAnswer = parseInt(qDiv.querySelector('.correct-answer-mc')?.value || 0, 10);
                } else { // fill-in-the-blank or subjective
                    questionData.correctAnswer = qDiv.querySelector('.correct-answer-text')?.value || '';
                }

                newSubjects[subjectName].push(questionData);
            });
        }
    });

    quizToSave.subjects = newSubjects;

    // Send updated quizzes to server
    try {
        const response = await fetch('/update-quizzes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(quizzesData)
        });
        if (!response.ok) throw new Error('Server error');
        alert('Quiz saved successfully!');
        renderQuizList();
    } catch (error) {
        alert('Failed to save quiz. Please try again.');
    }
}

async function saveAllQuizzesToServer(){
    try{
        const res=await fetch('/update-quizzes',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(quizzesData)});
        if(!res.ok) throw new Error("Server error");
        alert('Saved successfully'); renderQuizList();
    }catch(e){alert("Failed to save");}
}

function generatePDF(){
    const { jsPDF }=window.jspdf;
    const doc=new jsPDF();
    const quiz=quizzesData[selectedQuizIndex];
    let y=20; doc.setFontSize(18); doc.text(quiz.title,105,y,{align:'center'}); y+=10; let qNo=1;
    Object.keys(quiz.subjects).forEach(subject=>{
        if(y>260){doc.addPage(); y=20;}
        doc.setFontSize(14); doc.text(`Section: ${subject}`,14,y); y+=10;
        quiz.subjects[subject].forEach(q=>{
            if(y>260){doc.addPage(); y=20;}
            doc.setFontSize(12);
            const lines=doc.splitTextToSize(`${qNo}. ${q.text}`,180);
            doc.text(lines,14,y); y+=(lines.length*5)+5;
            if(q.type==='multiple-choice') q.options.forEach((opt,i)=>{doc.text(`   (${String.fromCharCode(97+i)}) ${opt}`,20,y); y+=7;}); else y+=10;
            qNo++;
        });
    });
    doc.save(`${quiz.title.replace(/\s+/g,'_')}.pdf`);
}

document.addEventListener('DOMContentLoaded',()=>{});
</script>
</body>
</html>
