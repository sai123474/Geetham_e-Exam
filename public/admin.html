<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - Geetham e-Exam</title>
    <link rel="icon" type="image/jpeg" href="/geetham.jpg">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; margin: 0; padding: 30px; }
        .container { max-width: 1200px; margin: auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { max-height: 80px; }
        h1, h3, h4, h5 { color: #0056b3; }
        .admin-panel { display: flex; gap: 30px; }
        .quiz-list { width: 300px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); align-self: flex-start; }
        .quiz-editor { flex-grow: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .quiz-list-item { padding: 15px; margin-bottom: 10px; border-radius: 6px; cursor: pointer; border: 1px solid #ddd; }
        .quiz-list-item.active { background-color: #e7f3ff; border-left: 4px solid #007bff; font-weight: bold; }
        label { font-weight: 600; color: #333; margin-top: 15px; display: block; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; font-size: 15px; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 12px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px; margin-top: 10px; }
        .btn-save { background-color: #28a745; }
        .btn-add { background-color: #17a2b8; }
        .btn-remove { background-color: #dc3545; padding: 5px 10px; font-size: 12px; }
        .btn-delete-quiz { background-color: #dc3545; }
        .btn-pdf { background-color: #ffc107; color: #212529; }
        .question-container, .subject-container { border: 1px solid #e9ecef; padding: 15px; margin-top: 15px; border-radius: 5px; background-color: #fdfdff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="/geetham.jpg" alt="Geetham Institute Logo" class="logo">
            <h1>Quiz Admin Panel</h1>
        </div>
        <div id="password-prompt">
            <input type="password" id="admin-password" placeholder="Enter Admin Password">
            <button onclick="login()">Login</button>
        </div>
        <div id="admin-panel" class="admin-panel" style="display:none;">
            <div class="quiz-list" id="quiz-list-panel"></div>
            <div class="quiz-editor" id="quiz-editor-panel"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    const ADMIN_PASSWORD = "admin123";
    let quizzesData = [];
    let selectedQuizIndex = 0;

    function login() {
        if (document.getElementById('admin-password').value === ADMIN_PASSWORD) {
            document.getElementById('password-prompt').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'flex';
            loadQuizzes();
        } else {
            alert('Incorrect password!');
        }
    }

    async function loadQuizzes() {
        try {
            const response = await fetch('/get-quizzes');
            quizzesData = await response.json();
            renderQuizList();
            renderQuizEditor();
        } catch (error) {
            alert("Could not load quiz data from the server.");
        }
    }

    function renderQuizList() {
        const listPanel = document.getElementById('quiz-list-panel');
        listPanel.innerHTML = '<h3>All Quizzes</h3>';
        quizzesData.forEach((quiz, index) => {
            const item = document.createElement('div');
            item.className = 'quiz-list-item';
            if (index === selectedQuizIndex) item.classList.add('active');
            item.textContent = quiz.title;
            item.onclick = () => {
                selectedQuizIndex = index;
                renderQuizList();
                renderQuizEditor();
            };
            listPanel.appendChild(item);
        });
        const addBtn = document.createElement('button');
        addBtn.className = 'btn-add';
        addBtn.textContent = 'Add New Quiz';
        addBtn.onclick = addQuiz;
        listPanel.appendChild(addBtn);
    }

    function renderQuizEditor() {
        const editorPanel = document.getElementById('quiz-editor-panel');
        const quiz = quizzesData[selectedQuizIndex];
        if (!quiz) {
            editorPanel.innerHTML = '<h3>Select a quiz to edit or add a new one.</h3>';
            return;
        }
        editorPanel.innerHTML = `
            <h3>Editing: ${quiz.title}</h3>
            <div id="quiz-details"></div>
            <div id="subjects-details"></div>
            <button class="btn-add" onclick="addSubject()">Add Subject</button>
            <div class="question-container" style="margin-top: 30px;">
                <h4>Generate Questions from Text using AI</h4>
                <p>Paste your questions and options below, then click generate.</p>
                <textarea id="ai-text-input" rows="10" placeholder="Paste question paper text here..."></textarea>
                <button class="btn-add" onclick="generateFromText()">Generate from Text</button>
            </div>
            <div style="margin-top: 20px; display:flex; justify-content:space-between; flex-wrap: wrap;">
                <div>
                    <button class="btn-save" onclick="saveQuiz()">Save This Quiz</button>
                    <button class="btn-delete-quiz" onclick="deleteQuiz()">Delete This Quiz</button>
                </div>
                <button class="btn-pdf" onclick="generatePDF()">Download as PDF</button>
            </div>
        `;
        renderQuizDetails(quiz);
        renderSubjects(quiz.subjects);
    }

    function renderQuizDetails(quiz) {
        document.getElementById('quiz-details').innerHTML = `
            <label>Title:</label><input type="text" id="quiz-title" value="${quiz.title}">
            <label>Time Limit (minutes):</label><input type="number" id="quiz-time" value="${quiz.timeLimit}">
            <label>Password:</label><input type="text" id="quiz-password" value="${quiz.password}">
        `;
    }

    function renderSubjects(subjects) {
        const container = document.getElementById('subjects-details');
        container.innerHTML = '<h4>Subjects</h4>';
        Object.keys(subjects).forEach(subjectName => {
            const subjectDiv = document.createElement('div');
            subjectDiv.className = 'subject-container';
            subjectDiv.innerHTML = `
                <label>Subject Name:</label>
                <input type="text" class="subject-name" value="${subjectName}">
                <button class="btn-remove" onclick="removeSubject(this)">Remove Subject</button>
                <div class="question-container">
                    <h5>Generate Questions for ${subjectName} with AI</h5>
                    <input type="text" id="topic-${subjectName}" placeholder="Enter topic (e.g., Laws of Motion)">
                    <input type="number" id="num-${subjectName}" value="3" style="width: 80px;">
                    <button class="btn-add" onclick="generateWithAI('${subjectName}')">Generate from Topic</button>
                </div>
            `;
            subjects[subjectName].forEach((q, qIndex) => {
                subjectDiv.appendChild(createQuestionElement(qIndex, q));
            });
            const addQBtn = document.createElement('button');
            addQBtn.className = 'btn-add';
            addQBtn.textContent = `Add Question`;
            addQBtn.onclick = () => addQuestion(subjectDiv);
            subjectDiv.appendChild(addQBtn);
            container.appendChild(subjectDiv);
        });
    }

    function createQuestionElement(qIndex, question) {
        const qDiv = document.createElement('div');
        qDiv.className = 'question-container';
        qDiv.innerHTML = `
            <h5>Question ${qIndex + 1} <button class="btn-remove" onclick="removeQuestion(this)">Remove</button></h5>
            <label>Question Text:</label><textarea rows="2">${question.text}</textarea>
            <label>Options:</label>
            <input type="text" value="${question.options[0]}">
            <input type="text" value="${question.options[1]}">
            <input type="text" value="${question.options[2]}">
            <input type="text" value="${question.options[3]}">
            <label>Correct Answer:</label>
            <select>
                <option value="0" ${question.correctAnswer === 0 ? 'selected' : ''}>Option 1</option>
                <option value="1" ${question.correctAnswer === 1 ? 'selected' : ''}>Option 2</option>
                <option value="2" ${question.correctAnswer === 2 ? 'selected' : ''}>Option 3</option>
                <option value="3" ${question.correctAnswer === 3 ? 'selected' : ''}>Option 4</option>
            </select>
        `;
        return qDiv;
    }

    function addQuiz() {
        quizzesData.push({ id: Date.now(), title: "New Mock Test", timeLimit: 180, password: "newpassword", subjects: {} });
        selectedQuizIndex = quizzesData.length - 1;
        renderQuizList();
        renderQuizEditor();
    }

    function addSubject() {
        const subjectName = prompt("Enter new subject name:");
        if (subjectName && !quizzesData[selectedQuizIndex].subjects[subjectName]) {
            quizzesData[selectedQuizIndex].subjects[subjectName] = [];
            renderQuizEditor();
        } else if (subjectName) {
            alert("A subject with this name already exists.");
        }
    }
    
    function removeSubject(button) {
        if (confirm('Are you sure you want to remove this subject and all its questions?')) {
            button.closest('.subject-container').remove();
        }
    }

   function addQuestion(subjectDiv) {
    const qIndex = subjectDiv.querySelectorAll('.question-container').length;
    const newQuestionElement = createQuestionElement(qIndex, { 
        type: 'multiple-choice', 
        text: 'New Question', 
        options: ["", "", "", ""], 
        correctAnswer: 0 
    });
    
    // Insert the new question form before the "Add Question" button
    subjectDiv.insertBefore(newQuestionElement, subjectDiv.querySelector('.btn-add'));
}

    function removeQuestion(button) {
        button.closest('.question-container').remove();
    }

    async function generateWithAI(subjectName) {
        const topic = document.getElementById(`topic-${subjectName}`).value;
        const numQuestions = document.getElementById(`num-${subjectName}`).value;
        if (!topic) {
            alert("Please enter a topic.");
            return;
        }
        try {
            const response = await fetch('/generate-questions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ topic, numQuestions })
            });
            if (!response.ok) throw new Error('AI generation failed.');
            const newQuestions = await response.json();
            quizzesData[selectedQuizIndex].subjects[subjectName].push(...newQuestions);
            renderQuizEditor();
            alert(`${newQuestions.length} questions generated for ${subjectName}!`);
        } catch (error) {
            alert("Could not generate questions from topic.");
        }
    }

    async function generateFromText() {
        const textInput = document.getElementById('ai-text-input').value;
        if (!textInput.trim()) return alert("Please paste text.");
        try {
            const response = await fetch('/generate-from-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: textInput })
            });
            if (!response.ok) throw new Error('AI generation failed.');
            const newQuestions = await response.json();
            newQuestions.forEach(q => {
                if (quizzesData[selectedQuizIndex].subjects[q.subject]) {
                    quizzesData[selectedQuizIndex].subjects[q.subject].push(q);
                }
            });
            renderQuizEditor();
            alert(`${newQuestions.length} questions generated and added!`);
        } catch (error) {
            alert("Could not generate questions from text.");
        }
    }

    async function deleteQuiz() {
        if (confirm(`Are you sure you want to delete "${quizzesData[selectedQuizIndex].title}"?`)) {
            quizzesData.splice(selectedQuizIndex, 1);
            await saveAllQuizzesToServer();
            selectedQuizIndex = 0;
            loadQuizzes();
        }
    }

    async function saveQuiz() {
    const quizToSave = quizzesData[selectedQuizIndex];
    if (!quizToSave) return;
    quizToSave.title = document.getElementById('quiz-title').value;
    quizToSave.timeLimit = parseInt(document.getElementById('quiz-time').value);
    quizToSave.password = document.getElementById('quiz-password').value;
    
    const newSubjects = {};
    document.querySelectorAll('.subject-container').forEach(subjectDiv => {
        const subjectNameInput = subjectDiv.querySelector('.subject-name');
        if (subjectNameInput && subjectNameInput.value) {
            const subjectName = subjectNameInput.value;
            newSubjects[subjectName] = [];
            subjectDiv.querySelectorAll('.question-container').forEach(qDiv => {
                const type = qDiv.querySelector('.question-type').value;
                const questionData = {
                    text: qDiv.querySelector('textarea').value,
                    type: type,
                };
                if (type === 'multiple-choice') {
                    questionData.options = Array.from(qDiv.querySelectorAll('.answer-fields input')).map(input => input.value);
                    questionData.correctAnswer = parseInt(qDiv.querySelector('.correct-answer-mc').value, 10);
                } else {
                    questionData.correctAnswer = qDiv.querySelector('.correct-answer-text').value;
                }
                newSubjects[subjectName].push(questionData);
            });
        }
    });
    quizToSave.subjects = newSubjects;
    await saveAllQuizzesToServer();
}

    async function saveAllQuizzesToServer() {
        try {
            const response = await fetch('/update-quizzes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(quizzesData)
            });
            if (!response.ok) throw new Error('Server error');
            alert('Changes saved successfully!');
            renderQuizList();
        } catch (error) {
            alert('Failed to save changes.');
        }
    }
    
    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const quiz = quizzesData[selectedQuizIndex];
        let y = 20;
        doc.setFontSize(18);
        doc.text(quiz.title, 105, y, { align: 'center' });
        y += 10;
        let questionCounter = 1;
        Object.keys(quiz.subjects).forEach(subjectName => {
            if (y > 260) { doc.addPage(); y = 20; }
            doc.setFontSize(14);
            doc.text(`Section: ${subjectName}`, 14, y);
            y += 10;
            quiz.subjects[subjectName].forEach(q => {
                if (y > 260) { doc.addPage(); y = 20; }
                doc.setFontSize(12);
                const textLines = doc.splitTextToSize(`${questionCounter}. ${q.text}`, 180);
                doc.text(textLines, 14, y);
                y += (textLines.length * 5) + 5;
                q.options.forEach((opt, index) => {
                    doc.text(`   (${String.fromCharCode(97 + index)}) ${opt}`, 20, y);
                    y += 7;
                });
                questionCounter++;
            });
        });
        doc.save(`${quiz.title.replace(/\s+/g, '_')}.pdf`);
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initial load
    });
</script>
</body>
</html>
