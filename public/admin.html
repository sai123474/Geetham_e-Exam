<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - Geetham e-Exam</title>
    <link rel="icon" type="image/jpeg" href="/geetham.jpg">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; margin: 0; padding: 30px; }
        .container { max-width: 1200px; margin: auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { max-height: 80px; }
        h1, h3, h4, h5 { color: #0056b3; }
        .admin-panel { display: flex; gap: 30px; }
        .quiz-list { width: 300px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); align-self: flex-start; }
        .quiz-editor { flex-grow: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);overflow-y: auto;}
        .quiz-list-item { padding: 15px; margin-bottom: 10px; border-radius: 6px; cursor: pointer; border: 1px solid #ddd; }
        .quiz-list-item.active { background-color: #e7f3ff; border-left: 4px solid #007bff; font-weight: bold; }
        label { font-weight: 600; color: #333; margin-top: 15px; display: block; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; font-size: 15px; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 12px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px; margin-top: 10px; }
        .btn-save { background-color: #28a745; }
        .btn-add { background-color: #17a2b8; }
        .btn-remove { background-color: #dc3545; padding: 5px 10px; font-size: 12px; }
        .btn-delete-quiz { background-color: #dc3545; }
        .btn-pdf { background-color: #ffc107; color: #212529; }
        .btn-review { background-color: #6f42c1; }
        .question-container, .subject-container { border: 1px solid #e9ecef; padding: 15px; margin-top: 15px; border-radius: 5px; background-color: #fdfdff; }
        .marks-badge { margin-left: 10px; font-weight: bold; font-size: 0.9rem; }
        .marks-badge .positive { color: #198754; }
        .marks-badge .negative { color: #dc3545; }
        .flex-row { display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
        .muted { color:#6c757d; font-size: 0.9rem; }
        /* Review dashboard */
        #review-dashboard { display:none; margin-top:20px; }
        .student-card { background: #ffffff; padding: 15px; margin: 10px 0; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.06); border:1px solid #eee;}
        .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:.8rem; background:#e9ecef; color:#343a40; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="/geetham.jpg" alt="Geetham Institute Logo" class="logo">
            <h1>Exam Admin Panel</h1>
        </div>
        <div id="password-prompt">
            <input type="password" id="admin-password" placeholder="Enter Admin Password">
            <button onclick="login()">Login</button>
        </div>
        <div id="admin-panel" class="admin-panel" style="display:none;">
            <div class="quiz-list" id="quiz-list-panel"></div>
            <div class="quiz-editor" id="quiz-editor-panel"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    let quizzesData = [];
    let selectedQuizIndex = 0;

    async function login() {
        const password = document.getElementById('admin-password').value;
        try {
            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            if (!response.ok) throw new Error('Login failed');
            const { accessToken } = await response.json();
            localStorage.setItem('adminToken', accessToken);
            document.getElementById('password-prompt').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'flex';
            loadQuizzes();
        } catch (error) {
            alert('Incorrect password or server error.');
        }
    }

    async function loadQuizzes() {
        try {
            const response = await fetch('/get-quizzes');
            quizzesData = await response.json();
            renderQuizList();
            renderQuizEditor();
        } catch (error) {
            alert("Could not load quiz data from the server.");
        }
    }

    function renderQuizList() {
        const listPanel = document.getElementById('quiz-list-panel');
        listPanel.innerHTML = '<h3>All Quizzes</h3>';
        quizzesData.forEach((quiz, index) => {
            const item = document.createElement('div');
            item.className = 'quiz-list-item' + (index === selectedQuizIndex ? ' active' : '');
            item.textContent = quiz.title;
            item.onclick = () => {
                selectedQuizIndex = index;
                renderQuizList();
                renderQuizEditor();
            };
            listPanel.appendChild(item);
        });
        const addBtn = document.createElement('button');
        addBtn.className = 'btn-add';
        addBtn.textContent = 'Add New Quiz';
        addBtn.onclick = addQuiz;
        listPanel.appendChild(addBtn);
    }

    function renderQuizEditor() {
        const editor = document.getElementById('quiz-editor-panel');
        const quiz = quizzesData[selectedQuizIndex];
        if (!quiz) {
            editor.innerHTML = '<h3>Select a quiz to edit or add a new one.</h3>';
            return;
        }
        editor.innerHTML = `
            <h3>Editing: ${quiz.title}</h3>
            <div id="quiz-details"></div>
            <div id="subjects-details"></div>
            <button class="btn-add" onclick="addSubject()">Add Subject</button>

            <div class="question-container" style="margin-top: 30px;">
                <h4>Generate Questions from Text using AI</h4>
                <textarea id="ai-text-input" rows="8" placeholder="Paste question paper text here..."></textarea>
                <button class="btn-add" onclick="generateFromText()">Generate from Text</button>
            </div>

            <div style="margin-top: 20px; display:flex; gap:10px; flex-wrap: wrap;">
                <div class="flex-row">
                    <button class="btn-save" onclick="saveQuiz()">Save This Quiz</button>
                    <button class="btn-delete-quiz" onclick="deleteQuiz()">Delete This Quiz</button>
                    <button class="btn-pdf" onclick="generatePDF()">Download as PDF</button>
                    <button class="btn-review" onclick="openReviewDashboard()">Teacher Review Dashboard</button>
                </div>
            </div>

            <div id="review-dashboard"></div>
        `;
        renderQuizDetails(quiz);
        renderSubjects(quiz.subjects);
        // listeners + initial computed values
        attachMarksListeners();
        updateAllQuestionBadges();
        updateTotalMarks();
    }

    function renderQuizDetails(quiz) {
        // defaults for new schema
        if (!quiz.marksMode) quiz.marksMode = 'uniform';
        if (quiz.correctMarks === undefined) quiz.correctMarks = 1;
        if (quiz.wrongMarks === undefined) quiz.wrongMarks = 0;

        document.getElementById('quiz-details').innerHTML = `
            <label>Title:</label><input type="text" id="quiz-title" value="${quiz.title}">
            <label>Time Limit (minutes):</label><input type="number" id="quiz-time" value="${quiz.timeLimit}">
            <label>Class:</label>
            <select id="quiz-class">
                ${[6,7,8,9,10,11,12].map(g => `<option value="${g}" ${quiz.class == g ? 'selected' : ''}>${g}th</option>`).join('')}
            </select>
            <label>Password:</label><input type="password" id="quiz-password" value="${quiz.password}">

            <label>Marks Mode:</label>
            <select id="quiz-marks-mode" onchange="renderQuizEditor()">
                <option value="uniform" ${quiz.marksMode !== "custom" ? "selected" : ""}>Uniform for all</option>
                <option value="custom" ${quiz.marksMode === "custom" ? "selected" : ""}>Custom per question</option>
            </select>

            <div id="marks-settings">
                ${quiz.marksMode === "custom" ? `
                    <p class="muted">Each question has its own marks fields.</p>
                ` : `
                    <label>Marks for Correct Answer:</label>
                    <input type="number" id="quiz-correct-marks" value="${quiz.correctMarks ?? 1}">
                    <label>Marks for Incorrect Answer:</label>
                    <input type="number" id="quiz-wrong-marks" value="${quiz.wrongMarks ?? 0}" step="0.25">
                `}
            </div>

            <h4>Total Marks: <span id="total-marks-display">0</span></h4>
        `;
    }

    function renderSubjects(subjects = {}) {
        const container = document.getElementById('subjects-details');
        container.innerHTML = '<h4>Subjects</h4>';
        Object.keys(subjects).forEach(subjectName => {
            const div = document.createElement('div');
            div.className = 'subject-container';
            div.innerHTML = `
                <div class="flex-row" style="justify-content:space-between;">
                    <div style="flex:1;">
                        <label>Subject Name:</label>
                        <input type="text" class="subject-name" value="${subjectName}">
                    </div>
                    <div>
                        <span class="pill" id="subject-total-${encodeURIComponent(subjectName)}">Total: 0</span>
                    </div>
                </div>
                <button class="btn-remove" onclick="removeSubject(this)">Remove Subject</button>
                <div class="question-container">
                    <h5>Generate Questions for ${subjectName} with AI</h5>
                    <input type="text" id="topic-${subjectName}" placeholder="Enter topic">
                    <input type="number" id="num-${subjectName}" value="3" style="width:80px">
                    <button class="btn-add" onclick="generateWithAI('${subjectName}')">Generate</button>
                </div>
            `;
            subjects[subjectName].forEach((q, i) => div.appendChild(createQuestionElement(i, q)));
            const addBtn = document.createElement('button');
            addBtn.className = 'btn-add';
            addBtn.textContent = 'Add Question';
            addBtn.onclick = () => addQuestion(div);
            div.appendChild(addBtn);
            container.appendChild(div);
        });
        // Update per-subject totals initially
        updateSubjectTotals();
    }

    function createQuestionElement(index, question = {}) {
        const quiz = quizzesData[selectedQuizIndex] || {};
        const mode = quiz.marksMode || 'uniform';
        const div = document.createElement('div');
        div.className = 'question-container';
        div.innerHTML = `
            <h5 class="flex-row">
                <span>Question ${index + 1}</span>
                <span class="marks-badge"> <span class="positive">+${mode === 'custom' ? (question.correctMarks ?? 1) : (quiz.correctMarks ?? 1)}</span>, <span class="negative">-${mode === 'custom' ? (question.wrongMarks ?? 0) : (quiz.wrongMarks ?? 0)}</span> </span>
                <button class="btn-remove" onclick="removeQuestion(this)">Remove</button>
            </h5>
            <label>Question Type:</label>
            <select class="question-type" onchange="toggleAnswerType(this)"></select>

            <label>Question Text:</label>
            <textarea rows="2">${question.text || ''}</textarea>

            <div class="answer-fields"></div>

            ${mode === "custom" ? `
                <div class="flex-row" style="gap:15px;">
                    <div style="min-width:180px;">
                        <label>Marks (Correct):</label>
                        <input type="number" class="question-correct-marks" value="${question.correctMarks ?? 1}">
                    </div>
                    <div style="min-width:180px;">
                        <label>Marks (Wrong):</label>
                        <input type="number" class="question-wrong-marks" value="${question.wrongMarks ?? 0}" step="0.25">
                    </div>
                </div>
            ` : ``}

            <div class="muted">${question.type === 'subjective' ? 'Subjective questions are manually graded.' : ''}</div>
        `;
        // Build select
        const select = div.querySelector('.question-type');
        ['multiple-choice', 'fill-in-the-blank', 'subjective'].forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t.replace(/-/g, ' ');
            if (t === (question.type || 'multiple-choice')) opt.selected = true;
            select.appendChild(opt);
        });
        toggleAnswerType(select, div.querySelector('.answer-fields'), question);
        return div;
    }

    function toggleAnswerType(select, container, question = {}) {
        if (!container) container = select.closest('.question-container').querySelector('.answer-fields');
        const type = select.value;

        if (type === 'multiple-choice') {
            container.innerHTML = '';
            for (let i = 0; i < 4; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = `Option ${i+1}`;
                input.value = question.options?.[i] || '';
                container.appendChild(input);
            }
            const correct = document.createElement('select');
            correct.className = 'correct-answer-mc';
            for (let i = 0; i < 4; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = 'Option ' + (i + 1);
                if (question.correctAnswer === i) opt.selected = true;
                correct.appendChild(opt);
            }
            container.appendChild(correct);
        } else if (type === 'fill-in-the-blank') {
            // Pipe-separated answers for synonyms; case-insensitive match on student side
            container.innerHTML = `
                <label>Correct Answers (use | to separate synonyms):</label>
                <input type="text" class="correct-answer-text" placeholder="e.g., Delhi|New Delhi" value="${(typeof question.correctAnswer === 'string' ? question.correctAnswer : '') || ''}">
            `;
        } else if (type === 'subjective') {
            container.innerHTML = `
                <label>Rubric / Expected Points (optional, for teachers):</label>
                <textarea class="subjective-rubric" rows="2">${question.rubric || ''}</textarea>
            `;
        }
        // After type change, re-attach listeners (for badges/marks in custom mode)
        attachMarksListeners();
    }

    function addQuiz() {
        quizzesData.push({
            id: Date.now(),
            title: "New Mock Test",
            timeLimit: 180,
            password: "newpassword",
            class: "12",
            marksMode: "uniform",
            correctMarks: 1,
            wrongMarks: 0,
            subjects: {}
        });
        selectedQuizIndex = quizzesData.length - 1;
        renderQuizList();
        renderQuizEditor();
    }

    function addSubject() {
        const name = prompt("Enter new subject name:");
        if (!name) return;
        if (quizzesData[selectedQuizIndex].subjects[name]) {
            alert("Subject already exists!");
            return;
        }
        quizzesData[selectedQuizIndex].subjects[name] = [];
        renderQuizEditor();
    }

    function removeSubject(btn) {
        if (confirm("Remove this subject and all its questions?")) {
            const subDiv = btn.closest('.subject-container');
            const name = subDiv.querySelector('.subject-name').value;
            delete quizzesData[selectedQuizIndex].subjects[name];
            subDiv.remove();
            updateTotalMarks();
        }
    }

    function addQuestion(subjectDiv) {
        const questions = subjectDiv.querySelectorAll(':scope > .question-container');
       const qIndex = Array.from(subjectDiv.querySelectorAll(':scope > .question-container'))
                .filter(q => !q.querySelector('h5')?.textContent.includes('Generate Questions')).length;

        const newQ = { type: 'multiple-choice', text: '', options: ["", "", "", ""], correctAnswer: 0, correctMarks: 1, wrongMarks: 0 };
        const newEl = createQuestionElement(qIndex + 1, newQ);

        // Insert before the subject-level Add button
        const addBtn = subjectDiv.querySelector(':scope > .btn-add');
        if (addBtn) {
            subjectDiv.insertBefore(newEl, addBtn);
        } else {
            subjectDiv.appendChild(newEl);
        }
        attachMarksListeners();
        updateQuestionBadge(newEl);
        updateTotalMarks();
        updateSubjectTotals();
    }

    function removeQuestion(btn) {
        btn.closest('.question-container').remove();
        updateTotalMarks();
        updateSubjectTotals();
    }

    async function generateWithAI(subjectName) {
        const topic = document.getElementById(`topic-${subjectName}`).value;
        const num = document.getElementById(`num-${subjectName}`).value;
        if (!topic) return alert("Enter a topic!");
        const token = localStorage.getItem('adminToken');
        if (!token) return alert("Please log in again.");
        try {
            const res = await fetch('/generate-questions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ topic, numQuestions: num })
            });
            const newQs = await res.json();
            quizzesData[selectedQuizIndex].subjects[subjectName].push(...newQs);
            renderQuizEditor();
            alert(`${newQs.length} questions added to ${subjectName}!`);
        } catch (e) {
            alert("AI generation failed.");
        }
    }

    async function generateFromText() {
        const text = document.getElementById('ai-text-input').value.trim();
        if (!text) return alert("Paste text first!");
        const token = localStorage.getItem('adminToken');
        if (!token) return alert("Please log in again.");
        try {
            const res = await fetch('/generate-from-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ text })
            });
            const newQs = await res.json();
            newQs.forEach(q => {
                if (quizzesData[selectedQuizIndex].subjects[q.subject]) {
                    quizzesData[selectedQuizIndex].subjects[q.subject].push(q);
                }
            });
            renderQuizEditor();
            alert(`${newQs.length} questions added!`);
        } catch (e) {
            alert("Failed to generate from text.");
        }
    }

    async function deleteQuiz() {
        if (confirm(`Delete "${quizzesData[selectedQuizIndex].title}"?`)) {
            quizzesData.splice(selectedQuizIndex, 1);
            await saveAllQuizzesToServer();
            selectedQuizIndex = 0;
            loadQuizzes();
        }
    }

    async function saveQuiz() {
        const quizToSave = quizzesData[selectedQuizIndex];
        if (!quizToSave) return;

        // Update quiz details
        quizToSave.title = document.getElementById('quiz-title')?.value || quizToSave.title;
        quizToSave.timeLimit = parseInt(document.getElementById('quiz-time')?.value) || quizToSave.timeLimit;
        quizToSave.class = document.getElementById('quiz-class').value;
        quizToSave.password = document.getElementById('quiz-password')?.value || quizToSave.password;
        quizToSave.marksMode = document.getElementById('quiz-marks-mode')?.value || 'uniform';

        if (quizToSave.marksMode === "uniform") {
            quizToSave.correctMarks = parseFloat(document.getElementById('quiz-correct-marks')?.value || 1);
            quizToSave.wrongMarks = parseFloat(document.getElementById('quiz-wrong-marks')?.value || 0);
        }

        const newSubjects = {};
        document.querySelectorAll('.subject-container').forEach(subDiv => {
            const name = subDiv.querySelector('.subject-name')?.value;
            if (!name) return;
            newSubjects[name] = [];

            // Only direct child question-containers (skip the AI generator block)
            subDiv.querySelectorAll(':scope > .question-container').forEach(qDiv => {
                // Skip the generator block that contains <h5>Generate Questions ...</h5>
                const isGenerator = qDiv.querySelector('h5') && qDiv.querySelector('h5').textContent.includes('Generate Questions for');
                if (isGenerator) return;

                const type = qDiv.querySelector('.question-type')?.value || 'multiple-choice';
                const qData = { text: qDiv.querySelector('textarea')?.value || '', type };

                if (type === 'multiple-choice') {
                    qData.options = Array.from(qDiv.querySelectorAll('.answer-fields input')).map(i => i.value);
                    qData.correctAnswer = parseInt(qDiv.querySelector('.correct-answer-mc')?.value || 0, 10);
                } else if (type === 'fill-in-the-blank') {
                    qData.correctAnswer = qDiv.querySelector('.correct-answer-text')?.value || '';
                } else if (type === 'subjective') {
                    qData.rubric = qDiv.querySelector('.subjective-rubric')?.value || '';
                    qData.correctAnswer = ''; // no automatic key
                }

                if (quizToSave.marksMode === "custom") {
                    qData.correctMarks = parseFloat(qDiv.querySelector('.question-correct-marks')?.value || 1);
                    qData.wrongMarks = parseFloat(qDiv.querySelector('.question-wrong-marks')?.value || 0);
                }

                newSubjects[name].push(qData);
            });
        });

        quizToSave.subjects = newSubjects;

        await saveAllQuizzesToServer();
       renderQuizList();
     renderQuizEditor();
    }

    async function saveAllQuizzesToServer() {
        const token = localStorage.getItem('adminToken');
        if (!token) return alert("Please log in again.");
        try {
            const response = await fetch('/update-quizzes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(quizzesData)
            });
            if (!response.ok) throw new Error('Server error');
            alert('Changes saved successfully!');
            renderQuizList();
        } catch (error) {
            alert('Failed to save changes.');
        }
    }

    // ---- Live totals & badges ----
    function updateTotalMarks() {
        // Use DOM for live accuracy
        const marksMode = document.getElementById('quiz-marks-mode')?.value || "uniform";
        let totalMarks = 0;

        if (marksMode === "custom") {
            document.querySelectorAll('.subject-container').forEach(subDiv => {
                // Only direct child questions (skip generator)
                subDiv.querySelectorAll(':scope > .question-container').forEach(qDiv => {
                    const isGenerator = qDiv.querySelector('h5') && qDiv.querySelector('h5').textContent.includes('Generate Questions for');
                    if (isGenerator) return;
                    const cm = parseFloat(qDiv.querySelector('.question-correct-marks')?.value || 1);
                    totalMarks += cm;
                });
            });
        } else {
            const correctMarks = parseFloat(document.getElementById('quiz-correct-marks')?.value || 1);
            let totalQuestions = 0;
            document.querySelectorAll('.subject-container').forEach(subDiv => {
                subDiv.querySelectorAll(':scope > .question-container').forEach(qDiv => {
                    const isGenerator = qDiv.querySelector('h5') && qDiv.querySelector('h5').textContent.includes('Generate Questions for');
                    if (!isGenerator) totalQuestions++;
                });
            });
            totalMarks = totalQuestions * correctMarks;
        }

        const totalMarksDisplay = document.getElementById('total-marks-display');
        if (totalMarksDisplay) totalMarksDisplay.textContent = totalMarks;

        updateSubjectTotals();
    }

    function updateSubjectTotals() {
        const marksMode = document.getElementById('quiz-marks-mode')?.value || "uniform";
        const uniformCorrect = parseFloat(document.getElementById('quiz-correct-marks')?.value || 1);

        document.querySelectorAll('.subject-container').forEach(subDiv => {
            let sum = 0;
            subDiv.querySelectorAll(':scope > .question-container').forEach(qDiv => {
                const isGenerator = qDiv.querySelector('h5') && qDiv.querySelector('h5').textContent.includes('Generate Questions for');
                if (isGenerator) return;
                if (marksMode === 'custom') {
                    sum += parseFloat(qDiv.querySelector('.question-correct-marks')?.value || 1);
                } else {
                    sum += uniformCorrect;
                }
            });
            const name = subDiv.querySelector('.subject-name')?.value || '';
            const pill = document.getElementById(`subject-total-${encodeURIComponent(name)}`);
            if (pill) pill.textContent = `Total: ${sum}`;
        });
    }

    function updateQuestionBadge(qDiv) {
        const marksMode = document.getElementById('quiz-marks-mode')?.value || "uniform";
        let cm = 1, wm = 0;
        if (marksMode === 'custom') {
            cm = parseFloat(qDiv.querySelector('.question-correct-marks')?.value || 1);
            wm = parseFloat(qDiv.querySelector('.question-wrong-marks')?.value || 0);
        } else {
            cm = parseFloat(document.getElementById('quiz-correct-marks')?.value || 1);
            wm = parseFloat(document.getElementById('quiz-wrong-marks')?.value || 0);
        }
        const badge = qDiv.querySelector('.marks-badge');
        if (badge) {
            badge.innerHTML = `<span class="positive">+${cm}</span>, <span class="negative">-${wm}</span>`;
        }
    }

    function updateAllQuestionBadges() {
        document.querySelectorAll('.subject-container :scope > .question-container').forEach(qDiv => {
            const isGenerator = qDiv.querySelector('h5') && qDiv.querySelector('h5').textContent.includes('Generate Questions for');
            if (!isGenerator) updateQuestionBadge(qDiv);
        });
    }

    function attachMarksListeners() {
        // Uniform fields
        document.getElementById('quiz-correct-marks')?.addEventListener('input', () => {
            updateTotalMarks();
            updateAllQuestionBadges();
        });
        document.getElementById('quiz-wrong-marks')?.addEventListener('input', () => {
            updateTotalMarks();
            updateAllQuestionBadges();
        });

        // Custom fields per question
        document.querySelectorAll('.question-correct-marks, .question-wrong-marks').forEach(inp => {
            inp.oninput = (e) => {
                const qDiv = e.target.closest('.question-container');
                updateQuestionBadge(qDiv);
                updateTotalMarks();
            };
        });

        // Also when subject name changes, keep totals aligned
        document.querySelectorAll('.subject-name').forEach(inp => {
            inp.addEventListener('input', updateSubjectTotals);
        });
    }

    // ---- PDF ----
    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const quiz = quizzesData[selectedQuizIndex];

        let y = 20;
        doc.setFontSize(18);
        doc.text(quiz.title, 105, y, { align: 'center' });
        y += 10;

        // Marks header
        doc.setFontSize(12);
        if (quiz.marksMode === "uniform") {
            doc.text(`Marks per correct: ${quiz.correctMarks ?? 1}, per wrong: ${quiz.wrongMarks ?? 0}`, 14, y); 
            y += 8;
            const totalQs = Object.values(quiz.subjects).reduce((acc, arr) => acc + arr.length, 0);
            doc.text(`Total Marks: ${(quiz.correctMarks ?? 1) * totalQs}`, 14, y);
            y += 12;
        } else {
            doc.text(`Custom Marks Mode Enabled`, 14, y);
            y += 12;
        }

        let qNo = 1;
        Object.keys(quiz.subjects).forEach(subject => {
            if (y > 260) { doc.addPage(); y = 20; }
            doc.setFontSize(14); doc.text(`Section: ${subject}`, 14, y); y += 10;

            quiz.subjects[subject].forEach(q => {
                if (y > 260) { doc.addPage(); y = 20; }
                doc.setFontSize(12);

                // Question text
                const lines = doc.splitTextToSize(`${qNo}. ${q.text}`, 180);
                doc.text(lines, 14, y); 
                y += (lines.length * 5) + 3;

                // Options or placeholders
                if (q.type === 'multiple-choice') {
                    q.options.forEach((opt, i) => { 
                        doc.text(`   (${String.fromCharCode(97 + i)}) ${opt}`, 20, y); 
                        y += 7; 
                    });
                } else if (q.type === 'fill-in-the-blank') {
                    doc.text(`   [Write your answer]`, 20, y);
                    y += 7;
                } else if (q.type === 'subjective') {
                    doc.text(`   [Answer in 3-5 lines]`, 20, y);
                    y += 7;
                }

                // Marks badge
                let cm = (quiz.marksMode === 'custom') ? (q.correctMarks ?? 1) : (quiz.correctMarks ?? 1);
                let wm = (quiz.marksMode === 'custom') ? (q.wrongMarks ?? 0) : (quiz.wrongMarks ?? 0);
                doc.text(`   Marks: +${cm}, -${wm}`, 20, y);
                y += 8;
                qNo++;
            });
        });
        doc.save(`${quiz.title.replace(/\s+/g, '_')}.pdf`);
    }

    // ---- Review Dashboard (basic scaffold) ----
    async function openReviewDashboard() {
        const container = document.getElementById('review-dashboard');
        const quiz = quizzesData[selectedQuizIndex];
        const token = localStorage.getItem('adminToken');

        container.style.display = 'block';
        container.innerHTML = `<h3>Teacher Review Dashboard — ${quiz.title}</h3><p class="muted">Subjective responses pending review.</p><div id="review-list">Loading…</div>`;

        try {
            // Expect backend to return: [{studentId, name, answers:[{qIndex, subject, type, answer, marks}]}]
            const res = await fetch(`/get-submissions?quizId=${encodeURIComponent(quiz.id)}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const submissions = await res.json();
            renderReviewList(submissions, quiz);
        } catch (e) {
            document.getElementById('review-list').innerHTML = `<div class="muted">Failed to load submissions.</div>`;
        }
    }

    function renderReviewList(submissions, quiz) {
        const wrap = document.getElementById('review-list');
        if (!Array.isArray(submissions) || submissions.length === 0) {
            wrap.innerHTML = `<div class="muted">No submissions found.</div>`;
            return;
        }
        wrap.innerHTML = '';
        submissions.forEach(s => {
            const card = document.createElement('div');
            card.className = 'student-card';
            const total = computeStudentTotal(s, quiz);
            card.innerHTML = `
                <h4>${s.name || 'Student'} (ID: ${s.studentId || '-'}) — <span class="pill">Total: ${total.total}</span> <span class="pill" style="background:#ffe69c;">Pending: ${total.pending}</span></h4>
                <div>${renderStudentAnswersHTML(s, quiz)}</div>
            `;
            wrap.appendChild(card);
        });
    }

    function renderStudentAnswersHTML(s, quiz) {
        // Render subjective items editable; others read-only
        const rows = [];
        (s.answers || []).forEach((ans, idx) => {
            const label = `Q${(ans.qNumber ?? idx+1)} — ${ans.subject || ''} (${ans.type})`;
            if (ans.type === 'subjective') {
                rows.push(`
                    <div style="border-top:1px dashed #ddd; padding-top:8px; margin-top:8px;">
                        <div><strong>${label}</strong></div>
                        <div class="muted">Answer:</div>
                        <div style="white-space:pre-wrap; background:#f8f9fa; padding:8px; border-radius:6px; border:1px solid #eee;">${escapeHTML(ans.answer || '')}</div>
                        <label style="margin-top:8px;">Marks:</label>
                        <input type="number" value="${typeof ans.marks === 'number' ? ans.marks : ''}" min="0" step="0.5"
                               data-student="${s.studentId}" data-qid="${ans.qId}" class="review-marks-input">
                        <button onclick="saveReviewedMarks('${s.studentId}','${ans.qId}')" class="btn-save">Save</button>
                    </div>
                `);
            } else {
                rows.push(`
                    <div style="border-top:1px dashed #eee; padding-top:6px; margin-top:6px;">
                        <div><strong>${label}</strong> — Marks: ${ans.marks}</div>
                    </div>
                `);
            }
        });
        return rows.join('');
    }

    function escapeHTML(str) {
        return (str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    function computeStudentTotal(s, quiz) {
        let total = 0;
        let pending = 0;
        (s.answers || []).forEach(ans => {
            if (ans.type === 'subjective') {
                if (typeof ans.marks === 'number') total += ans.marks;
                else pending++;
            } else {
                // MCQ / Fill already evaluated server-side ideally
                if (typeof ans.marks === 'number') total += ans.marks;
            }
        });
        return { total, pending };
    }

    async function saveReviewedMarks(studentId, qId) {
        const token = localStorage.getItem('adminToken');
        const input = document.querySelector(`.review-marks-input[data-student="${CSS.escape(studentId)}"][data-qid="${CSS.escape(qId)}"]`);
        const marks = parseFloat(input.value);
        if (isNaN(marks)) return alert('Enter valid marks');
        try {
            const res = await fetch('/grade-subjective', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ studentId, qId, marks })
            });
            if (!res.ok) throw new Error('Save failed');
            alert('Marks saved');
            // refresh dashboard
            openReviewDashboard();
        } catch (e) {
            alert('Failed to save marks');
        }
    }

    // ---- DOM Ready ----
    document.addEventListener('DOMContentLoaded', () => {});

</script>
</body>
</html>
