<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - Geetham e-Exam</title>
    <link rel="icon" type="image/jpeg" href="/geetham.jpg">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; margin: 0; padding: 30px; }
        .container { max-width: 1200px; margin: auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { max-height: 80px; }
        h1, h3, h4, h5 { color: #0056b3; }
        .admin-panel { display: flex; gap: 30px; }
        .quiz-list { width: 300px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); align-self: flex-start; }
        .quiz-editor { flex-grow: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .quiz-list-item { padding: 15px; margin-bottom: 10px; border-radius: 6px; cursor: pointer; border: 1px solid #ddd; }
        .quiz-list-item.active { background-color: #e7f3ff; border-left: 4px solid #007bff; font-weight: bold; }
        label { font-weight: 600; color: #333; margin-top: 15px; display: block; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; font-size: 15px; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 12px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px; margin-top: 10px; }
        .btn-save { background-color: #28a745; }
        .btn-add { background-color: #17a2b8; }
        .btn-remove { background-color: #dc3545; padding: 5px 10px; font-size: 12px; }
        .btn-delete-quiz { background-color: #dc3545; }
        .question-container, .subject-container { border: 1px solid #e9ecef; padding: 15px; margin-top: 15px; border-radius: 5px; background-color: #fdfdff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="/geetham.jpg" alt="Geetham Institute Logo" class="logo">
            <h1>Quiz Admin Panel</h1>
        </div>
        <div id="password-prompt">
            <input type="password" id="admin-password" placeholder="Enter Admin Password">
            <button onclick="login()">Login</button>
        </div>
        <div id="admin-panel" class="admin-panel" style="display:none;">
            <div class="quiz-list" id="quiz-list-panel"></div>
            <div class="quiz-editor" id="quiz-editor-panel"></div>
        </div>
    </div>

<script>
    const ADMIN_PASSWORD = "geetham";
    let quizzesData = [];
    let selectedQuizIndex = 0;

    function login() {
        if (document.getElementById('admin-password').value === ADMIN_PASSWORD) {
            document.getElementById('password-prompt').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'flex';
            loadQuizzes();
        } else {
            alert('Incorrect password!');
        }
    }

    async function loadQuizzes() {
        try {
            const response = await fetch('/get-quizzes');
            quizzesData = await response.json();
            renderQuizList();
            renderQuizEditor();
        } catch (error) {
            alert("Could not load quiz data from the server.");
        }
    }

    function renderQuizList() {
        const listPanel = document.getElementById('quiz-list-panel');
        listPanel.innerHTML = '<h3>All Quizzes</h3>';
        quizzesData.forEach((quiz, index) => {
            const item = document.createElement('div');
            item.className = 'quiz-list-item';
            if (index === selectedQuizIndex) item.classList.add('active');
            item.textContent = quiz.title;
            item.onclick = () => {
                selectedQuizIndex = index;
                renderQuizList();
                renderQuizEditor();
            };
            listPanel.appendChild(item);
        });
        const addBtn = document.createElement('button');
        addBtn.className = 'btn-add';
        addBtn.textContent = 'Add New Quiz';
        addBtn.onclick = addQuiz;
        listPanel.appendChild(addBtn);
    }

    function renderQuizEditor() {
        const editorPanel = document.getElementById('quiz-editor-panel');
        const quiz = quizzesData[selectedQuizIndex];
        if (!quiz) {
            editorPanel.innerHTML = '<h3>Select a quiz to edit or add a new one.</h3>';
            return;
        }
        editorPanel.innerHTML = `
            <h3>Editing: ${quiz.title}</h3>
            <div id="quiz-details"></div>
            <div id="subjects-details"></div>
            <div class="question-container" style="margin-top: 30px;">
                <h4>Generate Questions from Text using AI</h4>
                <p>Paste your questions and options below, then click generate.</p>
                <textarea id="ai-text-input" rows="10" placeholder="Paste question paper text here..."></textarea>
                <button class="btn-add" onclick="generateFromText()">Generate from Text</button>
            </div>
            <div style="margin-top: 20px; display:flex; justify-content:space-between;">
                <button class="btn-save" onclick="saveQuiz()">Save This Quiz</button>
                <button class="btn-delete-quiz" onclick="deleteQuiz()">Delete This Quiz</button>
            </div>
        `;
        renderQuizDetails(quiz);
        renderSubjects(quiz.subjects);
    }

    function renderQuizDetails(quiz) {
        document.getElementById('quiz-details').innerHTML = `
            <label>Title:</label><input type="text" id="quiz-title" value="${quiz.title}">
            <label>Time Limit (minutes):</label><input type="number" id="quiz-time" value="${quiz.timeLimit}">
            <label>Password:</label><input type="text" id="quiz-password" value="${quiz.password}">
            <label>Class:</label>
            <select id="quiz-class">
                <option value="6" ${quiz.class === "6" ? 'selected' : ''}>6th</option>
                <option value="7" ${quiz.class === "7" ? 'selected' : ''}>7th</option>
                <option value="8" ${quiz.class === "8" ? 'selected' : ''}>8th</option>
                <option value="9" ${quiz.class === "9" ? 'selected' : ''}>9th</option>
                <option value="10" ${quiz.class === "10" ? 'selected' : ''}>10th</option>
                <option value="11" ${quiz.class === "11" ? 'selected' : ''}>11th</option>
                <option value="12" ${quiz.class === "12" ? 'selected' : ''}>12th</option>
            </select>
        `;
    }

    function renderSubjects(subjects) {
        const container = document.getElementById('subjects-details');
        container.innerHTML = '';
        Object.keys(subjects).forEach(subjectName => {
            const subjectDiv = document.createElement('div');
            subjectDiv.className = 'subject-container';
            subjectDiv.innerHTML = `
                <h4>${subjectName}</h4>
                <div class="question-container">
                    <h5>Generate Questions for ${subjectName} with AI</h5>
                    <input type="text" id="topic-${subjectName}" placeholder="Enter topic (e.g., Laws of Motion)">
                    <input type="number" id="num-${subjectName}" value="3" style="width: 80px;">
                    <button class="btn-add" onclick="generateWithAI('${subjectName}')">Generate from Topic</button>
                </div>
            `;
            subjects[subjectName].forEach((q, qIndex) => {
                subjectDiv.appendChild(createQuestionElement(subjectName, qIndex, q));
            });
            const addQBtn = document.createElement('button');
            addQBtn.className = 'btn-add';
            addQBtn.textContent = `Add Question to ${subjectName}`;
            addQBtn.onclick = () => addQuestion(subjectName);
            subjectDiv.appendChild(addQBtn);
            container.appendChild(subjectDiv);
        });
    }

    function createQuestionElement(subjectName, qIndex, question) {
        const qDiv = document.createElement('div');
        qDiv.className = 'question-container';
        qDiv.dataset.subject = subjectName;
        let optionsHTML = '';
        question.options.forEach((opt, optIndex) => {
            optionsHTML += `<label>Option ${optIndex + 1}:</label><input type="text" value="${opt}">`;
        });
        qDiv.innerHTML = `
            <h5>Question ${qIndex + 1} <button class="btn-remove" onclick="removeQuestion(this, '${subjectName}', ${qIndex})">Remove</button></h5>
            <label>Question Text:</label><textarea rows="2">${question.text}</textarea>
            <label>Image URL (Optional):</label><input type="text" value="${question.imageUrl || ''}">
            ${optionsHTML}
            <label>Correct Answer:</label>
            <select>
                <option value="0" ${question.correctAnswer === 0 ? 'selected' : ''}>Option 1</option>
                <option value="1" ${question.correctAnswer === 1 ? 'selected' : ''}>Option 2</option>
                <option value="2" ${question.correctAnswer === 2 ? 'selected' : ''}>Option 3</option>
                <option value="3" ${question.correctAnswer === 3 ? 'selected' : ''}>Option 4</option>
            </select>
        `;
        return qDiv;
    }

    function addQuiz() {
        quizzesData.push({
            id: Date.now(),
            title: "New Mock Test",
            timeLimit: 180,
            password: "newpassword",
            class: "12",
            subjects: { "Physics": [], "Chemistry": [], "Mathematics": [] }
        });
        selectedQuizIndex = quizzesData.length - 1;
        renderQuizList();
        renderQuizEditor();
    }

    function addQuestion(subjectName) {
        quizzesData[selectedQuizIndex].subjects[subjectName].push({
            text: "New Question", options: ["", "", "", ""], correctAnswer: 0
        });
        renderQuizEditor();
    }

    function removeQuestion(button, subjectName, qIndex) {
        if (confirm('Are you sure?')) {
            quizzesData[selectedQuizIndex].subjects[subjectName].splice(qIndex, 1);
            button.closest('.question-container').remove();
        }
    }

    async function generateWithAI(subjectName) {
        const topic = document.getElementById(`topic-${subjectName}`).value;
        const numQuestions = document.getElementById(`num-${subjectName}`).value;
        if (!topic) {
            alert("Please enter a topic.");
            return;
        }
        try {
            const response = await fetch('/generate-questions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ topic, numQuestions })
            });
            if (!response.ok) throw new Error('AI generation failed.');
            const newQuestions = await response.json();
            quizzesData[selectedQuizIndex].subjects[subjectName].push(...newQuestions);
            renderQuizEditor();
            alert(`${newQuestions.length} questions generated for ${subjectName}!`);
        } catch (error) {
            alert("Could not generate questions from topic.");
        }
    }

    async function generateFromText() {
        const textInput = document.getElementById('ai-text-input').value;
        if (!textInput.trim()) return alert("Please paste text.");
        try {
            const response = await fetch('/generate-from-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: textInput })
            });
            if (!response.ok) throw new Error('AI generation failed.');
            const newQuestions = await response.json();
            newQuestions.forEach(q => {
                if (quizzesData[selectedQuizIndex].subjects[q.subject]) {
                    quizzesData[selectedQuizIndex].subjects[q.subject].push(q);
                }
            });
            renderQuizEditor();
            alert(`${newQuestions.length} questions generated and added!`);
        } catch (error) {
            alert("Could not generate questions from text.");
        }
    }

    async function deleteQuiz() {
        if (confirm(`Are you sure you want to delete "${quizzesData[selectedQuizIndex].title}"?`)) {
            quizzesData.splice(selectedQuizIndex, 1);
            await saveAllQuizzesToServer();
            selectedQuizIndex = 0;
            loadQuizzes();
        }
    }

    async function saveQuiz() {
        const quizToSave = quizzesData[selectedQuizIndex];
        if (!quizToSave) return;
        quizToSave.title = document.getElementById('quiz-title').value;
        quizToSave.timeLimit = parseInt(document.getElementById('quiz-time').value);
        quizToSave.password = document.getElementById('quiz-password').value;
        quizToSave.class = document.getElementById('quiz-class').value;
        const newSubjects = {};
        document.querySelectorAll('.subject-container').forEach(subjectDiv => {
            const subjectName = subjectDiv.querySelector('h4').textContent;
            newSubjects[subjectName] = [];
            subjectDiv.querySelectorAll('.question-container').forEach(qDiv => {
                const inputs = qDiv.querySelectorAll('input');
                newSubjects[subjectName].push({
                    text: qDiv.querySelector('textarea').value,
                    imageUrl: inputs[0].value || undefined,
                    options: [inputs[1].value, inputs[2].value, inputs[3].value, inputs[4].value],
                    correctAnswer: parseInt(qDiv.querySelector('select').value)
                });
            });
        });
        quizToSave.subjects = newSubjects;
        await saveAllQuizzesToServer();
    }

    async function saveAllQuizzesToServer() {
        try {
            const response = await fetch('/update-quizzes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(quizzesData)
            });
            if (!response.ok) throw new Error('Server error');
            alert('Changes saved successfully!');
            renderQuizList();
        } catch (error) {
            alert('Failed to save changes.');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initial load
    });
</script>
</body>
</html>
