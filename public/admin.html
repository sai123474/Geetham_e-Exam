<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - Geetham e-Exam</title>
    <link rel="icon" type="image/jpeg" href="/geetham.jpg">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; margin: 0; padding: 30px; }
        .container { max-width: 1200px; margin: auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { max-height: 80px; }
        h1, h3, h4, h5 { color: #0056b3; }
        .admin-panel { display: flex; gap: 30px; }
        .quiz-list { width: 300px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); align-self: flex-start; }
        .quiz-editor { flex-grow: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .quiz-list-item { padding: 15px; margin-bottom: 10px; border-radius: 6px; cursor: pointer; border: 1px solid #ddd; }
        .quiz-list-item.active { background-color: #e7f3ff; border-left: 4px solid #007bff; font-weight: bold; }
        label { font-weight: 600; color: #333; margin-top: 15px; display: block; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; font-size: 15px; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 12px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px; margin-top: 10px; }
        .btn-save { background-color: #28a745; }
        .btn-add { background-color: #17a2b8; }
        .btn-remove { background-color: #dc3545; padding: 5px 10px; font-size: 12px; }
        .btn-delete-quiz { background-color: #dc3545; }
        .btn-pdf { background-color: #ffc107; color: #212529; }
        .question-container, .subject-container { border: 1px solid #e9ecef; padding: 15px; margin-top: 15px; border-radius: 5px; background-color: #fdfdff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="/geetham.jpg" alt="Geetham Institute Logo" class="logo">
            <h1>Quiz Admin Panel</h1>
        </div>
        <div id="password-prompt">
            <input type="password" id="admin-password" placeholder="Enter Admin Password">
            <button onclick="login()">Login</button>
        </div>
        <div id="admin-panel" class="admin-panel" style="display:none;">
            <div class="quiz-list" id="quiz-list-panel"></div>
            <div class="quiz-editor" id="quiz-editor-panel"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    const ADMIN_PASSWORD = "admin123";
    let quizzesData = [];
    let selectedQuizIndex = 0;

    function login() {
        if (document.getElementById('admin-password').value === ADMIN_PASSWORD) {
            document.getElementById('password-prompt').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'flex';
            loadQuizzes();
        } else {
            alert('Incorrect password!');
        }
    }

    async function loadQuizzes() {
        try {
            const response = await fetch('/get-quizzes');
            quizzesData = await response.json();
            renderQuizList();
            renderQuizEditor();
        } catch (error) {
            alert("Could not load quiz data from the server.");
        }
    }

    function renderQuizList() {
        const listPanel = document.getElementById('quiz-list-panel');
        listPanel.innerHTML = '<h3>All Quizzes</h3>';
        quizzesData.forEach((quiz, index) => {
            const item = document.createElement('div');
            item.className = 'quiz-list-item';
            if (index === selectedQuizIndex) item.classList.add('active');
            item.textContent = quiz.title;
            item.onclick = () => {
                selectedQuizIndex = index;
                renderQuizList();
                renderQuizEditor();
            };
            listPanel.appendChild(item);
        });
        const addBtn = document.createElement('button');
        addBtn.className = 'btn-add';
        addBtn.textContent = 'Add New Quiz';
        addBtn.onclick = addQuiz;
        listPanel.appendChild(addBtn);
    }

    function renderQuizEditor() {
        const editorPanel = document.getElementById('quiz-editor-panel');
        const quiz = quizzesData[selectedQuizIndex];
        if (!quiz) {
            editorPanel.innerHTML = '<h3>Select a quiz to edit or add a new one.</h3>';
            return;
        }
        editorPanel.innerHTML = `
            <h3>Editing: ${quiz.title}</h3>
            <div id="quiz-details"></div>
            <div id="subjects-details"></div>
            <div style="margin-top: 20px; display:flex; justify-content:space-between; flex-wrap: wrap;">
                <div>
                    <button class="btn-save" onclick="saveQuiz()">Save This Quiz</button>
                    <button class="btn-delete-quiz" onclick="deleteQuiz()">Delete This Quiz</button>
                </div>
                <button class="btn-pdf" onclick="generatePDF()">Download as PDF</button>
            </div>
        `;
        renderQuizDetails(quiz);
        renderSubjects(quiz.subjects);
    }

    function renderQuizDetails(quiz) {
        document.getElementById('quiz-details').innerHTML = `
            <label>Title:</label><input type="text" id="quiz-title" value="${quiz.title}">
            <label>Time Limit (minutes):</label><input type="number" id="quiz-time" value="${quiz.timeLimit}">
            <label>Password:</label><input type="text" id="quiz-password" value="${quiz.password}">
            <label>Class:</label>
            <select id="quiz-class">
                <option value="11" ${quiz.class === "11" ? 'selected' : ''}>11th</option>
                <option value="12" ${quiz.class === "12" ? 'selected' : ''}>12th</option>
            </select>
        `;
    }

    function renderSubjects(subjects) {
        const container = document.getElementById('subjects-details');
        container.innerHTML = '';
        Object.keys(subjects).forEach(subjectName => {
            const subjectDiv = document.createElement('div');
            subjectDiv.className = 'subject-container';
            subjectDiv.innerHTML = `<h4>${subjectName}</h4>`;
            subjects[subjectName].forEach((q, qIndex) => {
                subjectDiv.appendChild(createQuestionElement(subjectName, qIndex, q));
            });
            const addQBtn = document.createElement('button');
            addQBtn.className = 'btn-add';
            addQBtn.textContent = `Add Question to ${subjectName}`;
            addQBtn.onclick = () => addQuestion(subjectName);
            subjectDiv.appendChild(addQBtn);
            container.appendChild(subjectDiv);
        });
    }

    function createQuestionElement(subjectName, qIndex, question) {
        const qDiv = document.createElement('div');
        qDiv.className = 'question-container';
        qDiv.dataset.subject = subjectName;
        qDiv.innerHTML = `
            <h5>Question ${qIndex + 1} <button class="btn-remove" onclick="removeQuestion(this, '${subjectName}', ${qIndex})">Remove</button></h5>
            <label>Question Type:</label>
            <select class="question-type" onchange="toggleAnswerType(this)">
                <option value="multiple-choice" ${!question.type || question.type === 'multiple-choice' ? 'selected' : ''}>Multiple Choice</option>
                <option value="fill-in-the-blank" ${question.type === 'fill-in-the-blank' ? 'selected' : ''}>Fill in the Blank</option>
                <option value="subjective" ${question.type === 'subjective' ? 'selected' : ''}>Subjective</option>
            </select>
            <label>Question Text:</label><textarea rows="2">${question.text}</textarea>
            <div class="answer-fields"></div>
        `;
        toggleAnswerType(qDiv.querySelector('.question-type'), qDiv.querySelector('.answer-fields'), question);
        return qDiv;
    }
    
    function toggleAnswerType(selectElement, answerFieldsDiv, question = {}) {
        if (!answerFieldsDiv) {
            answerFieldsDiv = selectElement.closest('.question-container').querySelector('.answer-fields');
        }
        const type = selectElement.value;
        if (type === 'fill-in-the-blank' || type === 'subjective') {
            answerFieldsDiv.innerHTML = `<label>Correct Answer / Keywords:</label><input type="text" class="correct-answer-text" value="${question.correctAnswer || ''}">`;
        } else {
            let optionsHTML = '';
            for (let i = 0; i < 4; i++) {
                optionsHTML += `<label>Option ${i + 1}:</label><input type="text" value="${question.options?.[i] || ''}">`;
            }
            answerFieldsDiv.innerHTML = `
                ${optionsHTML}
                <label>Correct Answer:</label>
                <select class="correct-answer-mc">
                    <option value="0" ${question.correctAnswer === 0 ? 'selected' : ''}>Option 1</option>
                    <option value="1" ${question.correctAnswer === 1 ? 'selected' : ''}>Option 2</option>
                    <option value="2" ${question.correctAnswer === 2 ? 'selected' : ''}>Option 3</option>
                    <option value="3" ${question.correctAnswer === 3 ? 'selected' : ''}>Option 4</option>
                </select>
            `;
        }
    }

    function addQuiz() {
        quizzesData.push({
            id: Date.now(),
            title: "New Mock Test",
            timeLimit: 180,
            password: "newpassword",
            class: "12",
            subjects: { "Physics": [], "Chemistry": [], "Mathematics": [] }
        });
        selectedQuizIndex = quizzesData.length - 1;
        renderQuizList();
        renderQuizEditor();
    }

    function addQuestion(subjectName) {
        quizzesData[selectedQuizIndex].subjects[subjectName].push({
            text: "New Question",
            type: "multiple-choice",
            options: ["", "", "", ""],
            correctAnswer: 0
        });
        renderQuizEditor();
    }

    function removeQuestion(button, subjectName, qIndex) {
        if (confirm('Are you sure?')) {
            quizzesData[selectedQuizIndex].subjects[subjectName].splice(qIndex, 1);
            button.closest('.question-container').remove();
        }
    }

    async function deleteQuiz() {
        if (confirm(`Are you sure you want to delete "${quizzesData[selectedQuizIndex].title}"?`)) {
            quizzesData.splice(selectedQuizIndex, 1);
            try {
                const response = await fetch('/update-quizzes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(quizzesData)
                });
                if (!response.ok) throw new Error('Server error');
                alert('Quiz deleted successfully.');
                selectedQuizIndex = 0;
                loadQuizzes();
            } catch (error) {
                alert('Failed to delete quiz.');
                loadQuizzes();
            }
        }
    }

    async function saveQuiz() {
        const quizToSave = quizzesData[selectedQuizIndex];
        if (!quizToSave) return;
        quizToSave.title = document.getElementById('quiz-title').value;
        quizToSave.timeLimit = parseInt(document.getElementById('quiz-time').value);
        quizToSave.password = document.getElementById('quiz-password').value;
        quizToSave.class = document.getElementById('quiz-class').value;
        const newSubjects = {};
        document.querySelectorAll('.subject-container').forEach(subjectDiv => {
            const subjectName = subjectDiv.querySelector('h4').textContent;
            newSubjects[subjectName] = [];
            subjectDiv.querySelectorAll('.question-container').forEach(qDiv => {
                const type = qDiv.querySelector('.question-type').value;
                const questionData = {
                    text: qDiv.querySelector('textarea').value,
                    type: type,
                };
                if (type === 'multiple-choice') {
                    questionData.options = Array.from(qDiv.querySelectorAll('.answer-fields input')).map(input => input.value);
                    questionData.correctAnswer = parseInt(qDiv.querySelector('.correct-answer-mc').value, 10);
                } else {
                    questionData.correctAnswer = qDiv.querySelector('.correct-answer-text').value;
                }
                newSubjects[subjectName].push(questionData);
            });
        });
        quizToSave.subjects = newSubjects;
        try {
            const response = await fetch('/update-quizzes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(quizzesData)
            });
            if (!response.ok) throw new Error('Server error');
            alert('Quiz saved successfully!');
            renderQuizList();
        } catch (error) {
            alert('Failed to save quiz.');
        }
    }
    
    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const quiz = quizzesData[selectedQuizIndex];
        let y = 20;
        doc.setFontSize(18);
        doc.text(quiz.title, 105, y, { align: 'center' });
        y += 10;
        let questionCounter = 1;
        Object.keys(quiz.subjects).forEach(subjectName => {
            if (y > 260) { doc.addPage(); y = 20; }
            doc.setFontSize(14);
            doc.text(`Section: ${subjectName}`, 14, y);
            y += 10;
            quiz.subjects[subjectName].forEach(q => {
                if (y > 260) { doc.addPage(); y = 20; }
                doc.setFontSize(12);
                const textLines = doc.splitTextToSize(`${questionCounter}. ${q.text}`, 180);
                doc.text(textLines, 14, y);
                y += (textLines.length * 5) + 5;
                if (q.type === 'multiple-choice') {
                    q.options.forEach((opt, index) => {
                        doc.text(`   (${String.fromCharCode(97 + index)}) ${opt}`, 20, y);
                        y += 7;
                    });
                } else {
                    y += 10; // Space for answer line
                }
                questionCounter++;
            });
        });
        doc.save(`${quiz.title.replace(/\s+/g, '_')}.pdf`);
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initial load
    });
</script>
</body>
</html>
